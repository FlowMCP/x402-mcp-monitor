<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Agent Validator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%236366f1'/><path d='M30 50l15 15 25-30' stroke='white' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['SFMono-Regular', 'Consolas', 'Liberation Mono', 'Menlo', 'monospace']
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen antialiased">

    <!-- Hero Section -->
    <div class="relative isolate overflow-hidden">
        <div aria-hidden="true" class="absolute inset-x-0 -top-40 -z-10 transform-gpu overflow-hidden blur-3xl sm:-top-80">
            <div style="clip-path: polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)" class="relative left-[calc(50%-11rem)] aspect-[1155/678] w-[72.1875rem] -translate-x-1/2 rotate-[30deg] bg-gradient-to-tr from-[#ff80b5] to-[#9089fc] opacity-20 sm:left-[calc(50%-30rem)] sm:w-[72.1875rem]"></div>
        </div>

        <div class="mx-auto max-w-3xl px-6 pt-20 pb-12 lg:pt-28 lg:pb-20">
            <!-- MCP Badge -->
            <div class="flex justify-center mb-8">
                <div class="inline-flex items-center gap-2 rounded-full px-4 py-1.5 text-sm ring-1 ring-white/10 hover:ring-white/20 transition-colors">
                    <span class="inline-block size-2 rounded-full bg-emerald-400 animate-pulse"></span>
                    <span class="text-gray-400">MCP Server at <code class="text-gray-300 font-mono">/mcp</code></span>
                    <span class="text-gray-600">·</span>
                    <span class="text-indigo-400">3 tools for AI agents</span>
                </div>
            </div>

            <!-- Title -->
            <h1 class="text-center text-5xl font-bold tracking-tight sm:text-6xl">
                <span class="text-white">MCP Agent</span><br>
                <span class="bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Validator</span>
            </h1>
            <p class="mt-6 text-center text-lg text-gray-400 max-w-xl mx-auto">
                Multi-protocol assessment for MCP servers, A2A agents, x402 payments, OAuth, and ERC-8004 registries
            </p>

            <!-- Tabs -->
            <div class="mt-10 flex justify-center">
                <nav class="inline-flex gap-1 p-1 rounded-xl bg-white/5 ring-1 ring-white/10" id="tabNav">
                    <button id="tabValidate" class="tab-btn active" onclick="switchTab('validate')">
                        <svg class="size-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" /></svg>
                        Validate Endpoint
                    </button>
                    <button id="tabLookup" class="tab-btn" onclick="switchTab('lookup')">
                        <svg class="size-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                        Lookup Agent
                    </button>
                </nav>
            </div>

            <!-- Validate Panel -->
            <div id="panelValidate" class="tab-panel mt-8">
                <div class="flex gap-3">
                    <input type="text" id="urlInput" placeholder="https://your-mcp-server.com/mcp" spellcheck="false"
                           class="flex-1 rounded-xl bg-white/5 px-5 py-3.5 text-base text-white ring-1 ring-white/10 placeholder:text-gray-500 focus:ring-2 focus:ring-indigo-500 font-mono outline-none transition-shadow">
                    <button id="validateBtn" onclick="validate()" class="rounded-xl bg-indigo-500 px-8 py-3.5 text-sm font-semibold text-white shadow-lg shadow-indigo-500/25 hover:bg-indigo-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
                        Validate
                    </button>
                </div>
                <div class="mt-3 flex items-center gap-3 text-sm text-gray-500">
                    <span>Try:</span>
                    <a class="example-link cursor-pointer text-indigo-400/80 hover:text-indigo-300 transition-colors" data-url="https://x402.flowmcp.org/mcp/streamable">x402.flowmcp.org</a>
                    <span class="text-gray-700">·</span>
                    <a class="example-link cursor-pointer text-indigo-400/80 hover:text-indigo-300 transition-colors" data-url="self">Self-Assessment</a>
                </div>
            </div>

            <!-- Lookup Panel -->
            <div id="panelLookup" class="tab-panel mt-8 hidden">
                <div class="flex gap-3">
                    <input type="number" id="agentIdInput" placeholder="Agent ID (e.g. 1)" min="1"
                           class="flex-1 rounded-xl bg-white/5 px-5 py-3.5 text-base text-white ring-1 ring-white/10 placeholder:text-gray-500 focus:ring-2 focus:ring-indigo-500 font-mono outline-none transition-shadow">
                    <select id="chainSelect" class="rounded-xl bg-white/5 px-4 py-3.5 text-sm text-gray-300 ring-1 ring-white/10 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer transition-shadow appearance-none">
                        <option value="84532">Base Sepolia</option>
                        <option value="11155111">Sepolia</option>
                        <option value="8453">Base</option>
                        <option value="1">Ethereum</option>
                        <option value="10">Optimism</option>
                        <option value="137">Polygon</option>
                        <option value="42161">Arbitrum</option>
                    </select>
                    <button id="lookupBtn" onclick="lookup()" class="rounded-xl bg-indigo-500 px-8 py-3.5 text-sm font-semibold text-white shadow-lg shadow-indigo-500/25 hover:bg-indigo-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap">
                        Lookup
                    </button>
                </div>
                <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-gray-500">
                    <span>Try:</span>
                    <a class="lookup-example cursor-pointer text-indigo-400/80 hover:text-indigo-300 transition-colors" data-id="9382" data-chain="1">Agent #9382 on Ethereum</a>
                    <span class="text-gray-700">·</span>
                    <a class="lookup-example cursor-pointer text-indigo-400/80 hover:text-indigo-300 transition-colors" data-id="2340" data-chain="8453">Agent #2340 on Base</a>
                    <span class="text-gray-700">·</span>
                    <a class="lookup-example cursor-pointer text-indigo-400/80 hover:text-indigo-300 transition-colors" data-id="1" data-chain="84532">Agent #1 on Base Sepolia</a>
                </div>
            </div>

            <!-- Error -->
            <div id="errorBox" class="mt-6 rounded-xl bg-red-500/10 ring-1 ring-red-500/30 px-5 py-3.5 text-red-400 text-sm" style="display:none"></div>

            <!-- Loading -->
            <div id="loadingSection" class="mt-16 text-center" style="display:none">
                <div class="loading-spinner inline-block"></div>
                <p id="loadingText" class="mt-4 text-gray-400 text-sm">Probing endpoint...</p>
            </div>
        </div>

        <div aria-hidden="true" class="absolute inset-x-0 top-[calc(100%-13rem)] -z-10 transform-gpu overflow-hidden blur-3xl sm:top-[calc(100%-30rem)]">
            <div style="clip-path: polygon(74.1% 44.1%, 100% 61.6%, 97.5% 26.9%, 85.5% 0.1%, 80.7% 2%, 72.5% 32.5%, 60.2% 62.4%, 52.4% 68.1%, 47.5% 58.3%, 45.2% 34.5%, 27.5% 76.7%, 0.1% 64.9%, 17.9% 100%, 27.6% 76.8%, 76.1% 97.7%, 74.1% 44.1%)" class="relative left-[calc(50%+3rem)] aspect-[1155/678] w-[72.1875rem] -translate-x-1/2 bg-gradient-to-tr from-[#ff80b5] to-[#9089fc] opacity-15 sm:left-[calc(50%+36rem)] sm:w-[72.1875rem]"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="mx-auto max-w-4xl px-6">
        <div id="resultsSection" class="results-section">
            <div class="verdict-grid" id="verdictGrid"></div>
            <div id="detailSections"></div>
        </div>
        <div id="rawAssessmentSection" class="raw-assessment-section" style="display:none"></div>
    </div>

    <!-- Features Section -->
    <div id="featuresSection" class="mx-auto max-w-5xl px-6 py-24">
        <div class="mx-auto max-w-2xl text-center">
            <h2 class="text-base font-semibold text-indigo-400">Multi-Protocol Assessment</h2>
            <p class="mt-2 text-3xl font-bold tracking-tight text-white sm:text-4xl">Everything checked in one probe</p>
            <p class="mt-4 text-gray-400">Seven protocol layers assessed simultaneously — from HTTP reachability to on-chain reputation</p>
        </div>
        <div class="mx-auto mt-16 grid grid-cols-1 gap-6 lg:grid-cols-3">
            <div class="rounded-2xl bg-white/[0.03] ring-1 ring-white/10 p-8 hover:ring-white/20 transition-all">
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex items-center justify-center size-10 rounded-lg bg-indigo-500/10 ring-1 ring-indigo-500/20">
                        <svg class="size-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" /></svg>
                    </div>
                    <h3 class="text-base font-semibold text-white">Endpoint Validation</h3>
                </div>
                <p class="text-sm text-gray-400 leading-relaxed">Full server-side assessment of MCP, A2A/AP2, x402 payments, OAuth 2.1, MCP Apps, and ERC-8004 — all from a single URL.</p>
                <div class="mt-6 flex flex-wrap gap-2">
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">MCP</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">A2A / AP2</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">x402</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">OAuth</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">MCP Apps</span>
                </div>
            </div>
            <div class="rounded-2xl bg-white/[0.03] ring-1 ring-white/10 p-8 hover:ring-white/20 transition-all">
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex items-center justify-center size-10 rounded-lg bg-indigo-500/10 ring-1 ring-indigo-500/20">
                        <svg class="size-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
                    </div>
                    <h3 class="text-base font-semibold text-white">Agent Lookup</h3>
                </div>
                <p class="text-sm text-gray-400 leading-relaxed">Query the ERC-8004 on-chain registry by agent ID. Returns registration data, service endpoints, verification status, and reputation.</p>
                <div class="mt-6 flex flex-wrap gap-2">
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">ERC-8004</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">On-Chain</span>
                    <span class="inline-flex items-center rounded-full bg-white/5 px-2.5 py-1 text-xs text-gray-400 ring-1 ring-white/10">Reputation</span>
                </div>
            </div>
            <div class="rounded-2xl bg-white/[0.03] ring-1 ring-white/10 p-8 hover:ring-white/20 transition-all">
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex items-center justify-center size-10 rounded-lg bg-emerald-500/10 ring-1 ring-emerald-500/20">
                        <svg class="size-5 text-emerald-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 0 1 7.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 0 1 1.06 0Z" /></svg>
                    </div>
                    <h3 class="text-base font-semibold text-white">MCP Server</h3>
                </div>
                <p class="text-sm text-gray-400 leading-relaxed">Connect AI agents directly via the built-in MCP server. Three tools available for programmatic validation, lookup, and client introspection.</p>
                <div class="mt-6">
                    <code class="block text-xs text-gray-500 font-mono bg-white/5 rounded-lg px-3 py-2 ring-1 ring-white/5">
                        <span class="text-emerald-400">POST</span> /mcp<br>
                        <span class="text-gray-600">├</span> validate_endpoint<br>
                        <span class="text-gray-600">├</span> lookup_agent<br>
                        <span class="text-gray-600">└</span> validate_client
                    </code>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-white/5">
        <div class="mx-auto max-w-5xl px-6 py-12">
            <!-- Protocol Badges -->
            <div class="flex flex-wrap justify-center gap-3 mb-8">
                <span class="inline-flex items-center gap-1.5 rounded-full bg-indigo-500/10 px-3 py-1 text-xs font-medium text-indigo-400 ring-1 ring-indigo-500/20">
                    <span class="size-1.5 rounded-full bg-indigo-400"></span>MCP
                </span>
                <span class="inline-flex items-center gap-1.5 rounded-full bg-purple-500/10 px-3 py-1 text-xs font-medium text-purple-400 ring-1 ring-purple-500/20">
                    <span class="size-1.5 rounded-full bg-purple-400"></span>A2A / AP2
                </span>
                <span class="inline-flex items-center gap-1.5 rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-medium text-emerald-400 ring-1 ring-emerald-500/20">
                    <span class="size-1.5 rounded-full bg-emerald-400"></span>x402
                </span>
                <span class="inline-flex items-center gap-1.5 rounded-full bg-amber-500/10 px-3 py-1 text-xs font-medium text-amber-400 ring-1 ring-amber-500/20">
                    <span class="size-1.5 rounded-full bg-amber-400"></span>OAuth 2.1
                </span>
                <span class="inline-flex items-center gap-1.5 rounded-full bg-cyan-500/10 px-3 py-1 text-xs font-medium text-cyan-400 ring-1 ring-cyan-500/20">
                    <span class="size-1.5 rounded-full bg-cyan-400"></span>MCP Apps
                </span>
                <span class="inline-flex items-center gap-1.5 rounded-full bg-rose-500/10 px-3 py-1 text-xs font-medium text-rose-400 ring-1 ring-rose-500/20">
                    <span class="size-1.5 rounded-full bg-rose-400"></span>ERC-8004
                </span>
            </div>

            <!-- Dependency Modules -->
            <div id="depInfo" class="dep-info text-center mb-8"></div>

            <!-- Divider -->
            <div class="border-t border-white/5 pt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <a href="https://github.com/FlowMCP/mcp-agent-validator" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-300 transition-colors">
                        <svg class="size-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0 1 12 6.844a9.59 9.59 0 0 1 2.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.02 10.02 0 0 0 22 12.017C22 6.484 17.522 2 12 2Z" clip-rule="evenodd" /></svg>
                    </a>
                    <span class="text-sm text-gray-500">Server-side multi-protocol assessment via Node.js probes</span>
                </div>
                <div class="text-xs text-gray-600">
                    Built by <a href="https://github.com/FlowMCP" target="_blank" rel="noopener" class="text-gray-400 hover:text-indigo-400 transition-colors">FlowMCP</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ── Chain Name Mapping ──

        var CHAIN_NAMES = {
            'eip155:1': 'Ethereum',
            'eip155:10': 'Optimism',
            'eip155:137': 'Polygon',
            'eip155:42161': 'Arbitrum',
            'eip155:8453': 'Base',
            'eip155:43113': 'Avalanche Fuji',
            'eip155:11155111': 'Ethereum Sepolia',
            'eip155:84532': 'Base Sepolia',
            'eip155:421614': 'Arbitrum Sepolia',
            'eip155:11155420': 'Optimism Sepolia',
            'solana:mainnet': 'Solana',
            'solana:devnet': 'Solana Devnet',
            'ETHEREUM_MAINNET': 'Ethereum',
            'OPTIMISM_MAINNET': 'Optimism',
            'BNB_MAINNET': 'BNB Smart Chain',
            'GNOSIS_MAINNET': 'Gnosis',
            'POLYGON_MAINNET': 'Polygon',
            'MONAD_MAINNET': 'Monad',
            'XLAYER_MAINNET': 'XLayer',
            'BASE_MAINNET': 'Base',
            'ARBITRUM_MAINNET': 'Arbitrum',
            'CELO_MAINNET': 'Celo',
            'AVALANCHE_MAINNET': 'Avalanche',
            'LINEA_MAINNET': 'Linea',
            'TAIKO_MAINNET': 'Taiko',
            'SCROLL_MAINNET': 'Scroll',
            'SEPOLIA_TESTNET': 'Sepolia',
            'BASE_SEPOLIA_TESTNET': 'Base Sepolia'
        }

        function chainLabel( caip2 ) {
            var name = CHAIN_NAMES[ caip2 ]

            return name ? caip2 + ' (' + name + ')' : caip2
        }

        // ── Helpers ──

        function escapeHtml( str ) {
            var div = document.createElement( 'div' )
            div.textContent = str

            return div.innerHTML
        }

        function show( el ) { el.style.display = 'block' }
        function hide( el ) { el.style.display = 'none' }

        function toggleSection( toggleEl ) {
            var content = toggleEl.nextElementSibling
            var arrow = toggleEl.querySelector( '.section-arrow' )

            if( content.style.display === 'none' ) {
                content.style.display = 'block'
                arrow.textContent = '\u25BC'
            } else {
                content.style.display = 'none'
                arrow.textContent = '\u25B6'
            }
        }

        function wrapCollapsible( title, innerHtml, defaultOpen ) {
            var arrow = defaultOpen ? '\u25BC' : '\u25B6'
            var display = defaultOpen ? 'block' : 'none'

            return '<div class="detail-section">' +
                '<div class="section-toggle" onclick="toggleSection(this)">' +
                '<span class="section-arrow">' + arrow + '</span>' +
                '<h3>' + escapeHtml( title ) + '</h3>' +
                '</div>' +
                '<div class="section-content" style="display:' + display + '">' +
                innerHtml +
                '</div>' +
                '</div>'
        }

        function renderCategoryGrid( obj ) {
            var html = '<div class="categories-grid">'

            Object.keys( obj ).forEach( function( key ) {
                var val = obj[ key ]

                if( val === null || val === undefined ) { return }

                var icon = val
                    ? '<span class="check-yes">&#10003;</span>'
                    : '<span class="check-no">&#10005;</span>'

                html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
            } )

            html += '</div>'

            return html
        }

        // ── Tab Switching ──

        function switchTab( tab ) {
            var validateTab = document.getElementById( 'tabValidate' )
            var lookupTab = document.getElementById( 'tabLookup' )
            var validatePanel = document.getElementById( 'panelValidate' )
            var lookupPanel = document.getElementById( 'panelLookup' )

            if( tab === 'validate' ) {
                validateTab.classList.add( 'active' )
                lookupTab.classList.remove( 'active' )
                validatePanel.classList.remove( 'hidden' )
                lookupPanel.classList.add( 'hidden' )
            } else {
                validateTab.classList.remove( 'active' )
                lookupTab.classList.add( 'active' )
                validatePanel.classList.add( 'hidden' )
                lookupPanel.classList.remove( 'hidden' )
            }
        }

        // ── State Management ──

        function setValidatorState( state ) {
            var loading = document.getElementById( 'loadingSection' )
            var results = document.getElementById( 'resultsSection' )
            var rawSection = document.getElementById( 'rawAssessmentSection' )
            var errorBox = document.getElementById( 'errorBox' )
            var features = document.getElementById( 'featuresSection' )
            var validateBtn = document.getElementById( 'validateBtn' )
            var lookupBtn = document.getElementById( 'lookupBtn' )

            hide( loading )
            hide( results )
            hide( rawSection )
            hide( errorBox )
            validateBtn.disabled = false
            lookupBtn.disabled = false

            if( state === 'loading' ) {
                show( loading )
                validateBtn.disabled = true
                lookupBtn.disabled = true
                features.style.display = 'none'
            } else if( state === 'results' ) {
                show( results )
                show( rawSection )
                features.style.display = 'none'
            } else {
                features.style.display = ''
            }
        }

        function showError( msg ) {
            var errorBox = document.getElementById( 'errorBox' )
            errorBox.textContent = msg
            show( errorBox )
        }

        function setLoadingText( text ) {
            document.getElementById( 'loadingText' ).textContent = text
        }

        // ── x402 Detail Helper ──

        function buildX402Detail( x402 ) {
            if( !x402 ) { return 'Supported' }

            var restrictedCalls = x402.restrictedCalls || []

            if( restrictedCalls.length > 0 ) {
                return restrictedCalls.length + ' payment tool' + ( restrictedCalls.length !== 1 ? 's' : '' )
            }

            var parts = []
            var networks = x402.networks || []

            if( networks.length > 0 ) {
                parts.push( networks.length + ' network' + ( networks.length !== 1 ? 's' : '' ) )
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                parts.push( schemes.join( ', ' ) )
            }

            return parts.length > 0 ? parts.join( ' · ' ) : 'Supported'
        }

        // ── Verdict Cards ──

        function renderVerdicts( data ) {
            var grid = document.getElementById( 'verdictGrid' )
            var cats = data.categories
            var http = data.entries.http
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var x402 = mcp ? mcp.x402 : null
            var oauth = mcp ? mcp.oauth : null
            var assessment = data.entries.assessment
            var summary = data.summary || {}

            var cards = [
                {
                    label: 'HTTP',
                    pass: cats.isHttpReachable,
                    detail: cats.isHttpReachable
                        ? ( cats.isHttps ? 'HTTPS' : 'HTTP' ) + ' · ' + ( summary.httpStatusCode || ( http ? http.statusCode : '-' ) ) + ( http && http.responseTimeMs !== null ? ' · ' + http.responseTimeMs + 'ms' : '' )
                        : 'Not reachable'
                },
                {
                    label: 'MCP',
                    pass: cats.supportsMcp,
                    detail: cats.supportsMcp
                        ? ( mcp.serverName || 'MCP Server' ) + ' (' + ( mcp.toolCount || 0 ) + ' tools)'
                        : 'Not detected'
                },
                {
                    label: 'A2A / AP2',
                    pass: cats.hasA2aCard,
                    detail: cats.hasA2aCard
                        ? ( a2a ? ( a2a.agentName || 'A2A Agent' ) : 'A2A Agent' )
                        : 'Not detected'
                },
                {
                    label: 'x402',
                    pass: cats.supportsX402,
                    detail: cats.supportsX402
                        ? buildX402Detail( x402 )
                        : 'Not detected'
                },
                {
                    label: 'OAuth',
                    pass: cats.supportsOAuth,
                    detail: cats.supportsOAuth
                        ? ( oauth ? ( oauth.issuer || 'OAuth detected' ) : 'OAuth detected' )
                        : 'Not required'
                },
                {
                    label: 'MCP Apps',
                    pass: cats.uiSupportsMcpApps,
                    detail: cats.uiSupportsMcpApps
                        ? ( ui ? ( ui.uiResourceCount + ' UI resource' + ( ui.uiResourceCount !== 1 ? 's' : '' ) ) : 'Detected' )
                        : 'Not detected'
                },
                {
                    label: 'ERC-8004',
                    pass: cats.hasErc8004Registration || cats.hasWellKnownRegistration,
                    detail: ( function() {
                        if( !cats.hasErc8004Registration && !cats.hasWellKnownRegistration ) { return 'Not registered' }
                        if( !cats.hasErc8004Registration ) { return 'Well-known found' }
                        var parts = [ 'On-chain' ]
                        if( cats.isErc8004OnChainVerified ) { parts.push( 'Verified' ) }
                        var e = data.entries.erc8004
                        if( e && e.chainAlias ) { parts.push( CHAIN_NAMES[ e.chainAlias ] || e.chainAlias ) }
                        return parts.join( ' · ' )
                    } )()
                }
            ]

            grid.innerHTML = cards.map( function( card ) {
                var cls = card.pass ? 'pass' : 'fail'
                var icon = card.pass
                    ? '<span class="check-yes" style="font-size:28px">&#10003;</span>'
                    : '<span class="check-no" style="font-size:28px">&#10005;</span>'

                return '<div class="verdict-card ' + cls + '">' +
                    '<div class="verdict-icon">' + icon + '</div>' +
                    '<div class="verdict-label">' + escapeHtml( card.label ) + '</div>' +
                    '<div class="verdict-detail">' + escapeHtml( card.detail ) + '</div>' +
                    '</div>'
            } ).join( '' )
        }

        // ── Detail Sections ──

        function renderDetails( data ) {
            var container = document.getElementById( 'detailSections' )
            var cats = data.categories
            var http = data.entries.http
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var erc8004 = data.entries.erc8004
            var reputation = data.entries.reputation
            var html = ''

            if( http ) {
                html += renderHttpDetail( http, cats )
            }

            if( cats.supportsMcp && mcp ) {
                html += renderMcpDetail( mcp, cats, ui )
            }

            if( cats.hasA2aCard && a2a ) {
                html += renderA2aDetail( a2a, cats )
            }

            if( cats.supportsX402 && mcp && mcp.x402 ) {
                html += renderX402Detail( mcp.x402, cats )
            }

            if( cats.supportsOAuth && mcp && mcp.oauth ) {
                html += renderOAuthDetail( mcp.oauth, cats )
            }

            if( cats.uiSupportsMcpApps && ui ) {
                html += renderMcpAppsDetail( ui, cats )
            }

            if( erc8004 || cats.hasWellKnownRegistration || cats.hasErc8004Registration ) {
                html += renderErc8004Detail( erc8004, reputation, cats )
            }

            if( data.messages && data.messages.length > 0 ) {
                html += renderMessages( data.messages )
            }

            container.innerHTML = html
        }

        // ── HTTP Detail ──

        function renderHttpDetail( http, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Protocol:</span> <span>' + escapeHtml( http.protocol || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Status Code:</span> <span>' + ( http.statusCode || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Response Time:</span> <span>' + ( http.responseTimeMs !== null ? http.responseTimeMs + ' ms' : '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Content-Type:</span> <span>' + escapeHtml( http.contentType || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">IP Address:</span> <span>' + escapeHtml( http.ipAddress || '-' ) + '</span></div>'

            if( http.serverHeader ) {
                inner += '<div class="field"><span class="label">Server:</span> <span>' + escapeHtml( http.serverHeader ) + '</span></div>'
            }

            if( cats.isHttps ) {
                inner += '<div class="field"><span class="label">TLS Version:</span> <span>' + escapeHtml( http.sslProtocol || '-' ) + '</span></div>'

                if( http.sslIssuer ) {
                    inner += '<div class="field"><span class="label">SSL Issuer:</span> <span>' + escapeHtml( http.sslIssuer ) + '</span></div>'
                }

                if( http.sslExpiresAt ) {
                    inner += '<div class="field"><span class="label">SSL Expires:</span> <span>' + escapeHtml( http.sslExpiresAt ) + '</span></div>'
                }
            }

            if( http.redirectChain && http.redirectChain.length > 0 ) {
                inner += '<div class="field"><span class="label">Redirects:</span> <span>' + http.redirectCount + '</span></div>'

                http.redirectChain.forEach( function( r ) {
                    inner += '<div class="field" style="padding-left:16px"><span class="label">' + r.statusCode + '</span> <span>'
                    inner += escapeHtml( r.from ) + ' &rarr; ' + escapeHtml( r.to )
                    inner += '</span></div>'
                } )
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'isHttpReachable': cats.isHttpReachable,
                'isHttps': cats.isHttps,
                'hasValidSsl': cats.hasValidSsl,
                'hasSslCertificate': cats.hasSslCertificate,
                'hasRedirects': cats.hasRedirects,
                'isWebsite': cats.isWebsite,
                'isApiEndpoint': cats.isApiEndpoint,
                'hasServerHeader': cats.hasServerHeader,
                'supportsCors': cats.supportsCors,
                'supportsHttp2': cats.supportsHttp2
            } )

            return wrapCollapsible( 'HTTP / HTTPS', inner, false )
        }

        // ── ERC-8004 Detail ──

        function renderEndpointLink( ep ) {
            var name = ep.name || 'link'
            var url = ep.endpoint || ''

            if( !url ) { return '' }

            var isLink = url.startsWith( 'http' ) || url.startsWith( 'did:' )
            var icon = ''
            var badgeClass = 'badge-blue'

            if( name === 'mcp' ) { icon = ''; badgeClass = 'badge-purple' }
            else if( name === 'a2a' || name === 'oasf' ) { badgeClass = 'badge-purple' }
            else if( name === 'web' || name === 'docs' ) { badgeClass = 'badge-green' }
            else if( name === 'email' ) { badgeClass = 'badge-green' }
            else if( name === 'twitter' ) { badgeClass = 'badge-blue' }
            else if( name === 'wallet' || name === 'basescan' ) { badgeClass = 'badge-green' }

            var html = '<div class="field" style="padding-left:16px">'
            html += '<span class="badge ' + badgeClass + '">' + escapeHtml( name ) + '</span> '

            if( name === 'email' ) {
                html += '<a href="mailto:' + escapeHtml( url ) + '" class="endpoint-link">' + escapeHtml( url ) + '</a>'
            } else if( isLink ) {
                html += '<a href="' + escapeHtml( url ) + '" target="_blank" rel="noopener" class="endpoint-link">' + escapeHtml( url ) + '</a>'
            } else {
                html += '<span style="font-family:monospace;font-size:12px">' + escapeHtml( url.length > 50 ? url.substring( 0, 24 ) + '...' + url.slice( -20 ) : url ) + '</span>'
            }

            if( ep.version ) {
                html += ' <span class="badge badge-blue" style="font-size:10px">' + escapeHtml( ep.version ) + '</span>'
            }

            html += '</div>'

            return html
        }

        function renderErc8004Detail( erc8004, reputation, cats ) {
            var inner = '<div class="probe-summary">'

            if( erc8004 ) {
                if( erc8004.image ) {
                    inner += '<div style="text-align:center;margin-bottom:16px"><img src="' + escapeHtml( erc8004.image ) + '" alt="Agent" style="width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,0.1)"></div>'
                }

                inner += '<div class="field"><span class="label">Agent ID:</span> <span>' + escapeHtml( String( erc8004.agentId ) ) + '</span></div>'
                inner += '<div class="field"><span class="label">Registry:</span> <span style="font-family:monospace;font-size:12px">' + escapeHtml( erc8004.agentRegistry || '-' ) + '</span></div>'
                var chainDisplayName = CHAIN_NAMES[ erc8004.chainAlias ] || erc8004.chainAlias || '-'
                inner += '<div class="field"><span class="label">Chain:</span> <span>' + escapeHtml( chainDisplayName ) + ( erc8004.chainId ? ' (' + erc8004.chainId + ')' : '' ) + '</span></div>'

                if( erc8004.owner ) {
                    inner += '<div class="field"><span class="label">Owner:</span> <span style="font-family:monospace;font-size:12px">' + escapeHtml( erc8004.owner ) + '</span></div>'
                }

                if( erc8004.registrationName ) {
                    inner += '<div class="field"><span class="label">Name:</span> <span>' + escapeHtml( erc8004.registrationName ) + '</span></div>'
                }

                if( erc8004.registrationDescription ) {
                    inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( erc8004.registrationDescription.substring( 0, 300 ) ) + ( erc8004.registrationDescription.length > 300 ? '...' : '' ) + '</span></div>'
                }

                inner += '<div class="field"><span class="label">On-Chain Verified:</span> <span>' + ( erc8004.isOnChainVerified ? 'Yes' : 'No' ) + '</span></div>'
                inner += '<div class="field"><span class="label">Spec Compliant:</span> <span>' + ( erc8004.isSpecCompliant ? 'Yes' : 'No' ) + '</span></div>'

                if( erc8004.uriType ) {
                    inner += '<div class="field"><span class="label">URI Type:</span> <span><span class="badge badge-blue">' + escapeHtml( erc8004.uriType ) + '</span></span></div>'
                }

                if( erc8004.x402Support !== null && erc8004.x402Support !== undefined ) {
                    inner += '<div class="field"><span class="label">x402 Support:</span> <span>' + ( erc8004.x402Support ? 'Yes' : 'No' ) + '</span></div>'
                }

                if( erc8004.isActive !== null && erc8004.isActive !== undefined ) {
                    inner += '<div class="field"><span class="label">Active:</span> <span>' + ( erc8004.isActive ? 'Yes' : 'No' ) + '</span></div>'
                }

                if( erc8004.supportedTrust && erc8004.supportedTrust.length > 0 ) {
                    inner += '<div class="field"><span class="label">Trust Models:</span> <span>'

                    erc8004.supportedTrust.forEach( function( t ) {
                        inner += '<span class="badge badge-purple">' + escapeHtml( t ) + '</span> '
                    } )

                    inner += '</span></div>'
                }

                if( erc8004.endpoints && erc8004.endpoints.length > 0 ) {
                    inner += '</div>'
                    inner += '<h3 style="margin-top:16px">Endpoints (' + erc8004.endpoints.length + ')</h3>'
                    inner += '<div class="probe-summary">'

                    erc8004.endpoints.forEach( function( ep ) {
                        inner += renderEndpointLink( ep )
                    } )
                } else if( erc8004.services && erc8004.services.length > 0 ) {
                    inner += '<div class="field"><span class="label">Services:</span> <span>' + erc8004.services.length + '</span></div>'

                    erc8004.services.forEach( function( svc ) {
                        inner += '<div class="field" style="padding-left:16px"><span class="label">' + escapeHtml( svc.type || 'service' ) + '</span> <span>'
                        inner += escapeHtml( svc.endpoint || svc.url || '-' )
                        inner += '</span></div>'
                    } )
                }

                if( erc8004.agentUri && !erc8004.endpoints ) {
                    inner += '<div class="field"><span class="label">Agent URI:</span> <span>'

                    if( erc8004.agentUri.startsWith( 'http' ) ) {
                        inner += '<a href="' + escapeHtml( erc8004.agentUri ) + '" target="_blank" rel="noopener" class="endpoint-link">' + escapeHtml( erc8004.agentUri.length > 60 ? erc8004.agentUri.substring( 0, 30 ) + '...' + erc8004.agentUri.slice( -24 ) : erc8004.agentUri ) + '</a>'
                    } else {
                        inner += '<span style="font-family:monospace;font-size:12px">' + escapeHtml( erc8004.agentUri.substring( 0, 80 ) ) + ( erc8004.agentUri.length > 80 ? '...' : '' ) + '</span>'
                    }

                    inner += '</span></div>'
                }

                if( erc8004.tags && erc8004.tags.length > 0 ) {
                    inner += '</div>'
                    inner += '<h3 style="margin-top:16px">Tags</h3>'
                    inner += '<div class="probe-summary"><div class="field"><span>'

                    var tagList = Array.isArray( erc8004.tags ) ? erc8004.tags : erc8004.tags[0].split( ', ' )

                    tagList.forEach( function( tag ) {
                        var t = typeof tag === 'string' ? tag.trim() : tag

                        if( t ) { inner += '<span class="badge badge-blue" style="margin:2px">' + escapeHtml( t ) + '</span> ' }
                    } )

                    inner += '</span></div>'
                }
            } else {
                inner += '<div class="field"><span class="label">Status:</span> <span>No on-chain registration found</span></div>'
            }

            if( reputation ) {
                inner += '</div>'
                inner += '<h3 style="margin-top:16px">On-Chain Reputation</h3>'
                inner += '<div class="probe-summary">'

                if( reputation.feedbackCount !== null ) {
                    inner += '<div class="field"><span class="label">Feedback Count:</span> <span>' + reputation.feedbackCount + '</span></div>'
                }

                if( reputation.averageValue !== null ) {
                    inner += '<div class="field"><span class="label">Average Value:</span> <span>' + reputation.averageValue + '</span></div>'
                }

                if( reputation.validationCount !== null ) {
                    inner += '<div class="field"><span class="label">Validation Count:</span> <span>' + reputation.validationCount + '</span></div>'
                }

                if( reputation.averageResponse !== null ) {
                    inner += '<div class="field"><span class="label">Avg Response:</span> <span>' + reputation.averageResponse + '</span></div>'
                }
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'hasWellKnownRegistration': cats.hasWellKnownRegistration,
                'hasErc8004Registration': cats.hasErc8004Registration,
                'isErc8004OnChainVerified': cats.isErc8004OnChainVerified,
                'isErc8004SpecCompliant': cats.isErc8004SpecCompliant,
                'hasOnChainReputation': cats.hasOnChainReputation
            } )

            return wrapCollapsible( 'ERC-8004 / Reputation', inner, true )
        }

        // ── MCP Detail ──

        function renderMcpDetail( mcp, cats, ui ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Server Name:</span> <span>' + escapeHtml( mcp.serverName || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Server Version:</span> <span>' + escapeHtml( mcp.serverVersion || '-' ) + '</span></div>'

            if( mcp.serverDescription ) {
                inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( mcp.serverDescription ) + '</span></div>'
            }

            if( mcp.protocolVersion ) {
                inner += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( mcp.protocolVersion ) + '</span></div>'
            }

            inner += '<div class="field"><span class="label">Tools:</span> <span>' + ( mcp.toolCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Resources:</span> <span>' + ( mcp.resourceCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Prompts:</span> <span>' + ( mcp.promptCount || 0 ) + '</span></div>'

            if( mcp.instructions ) {
                inner += '<div class="field"><span class="label">Instructions:</span> <span>' + escapeHtml( mcp.instructions.substring( 0, 200 ) ) + ( mcp.instructions.length > 200 ? '...' : '' ) + '</span></div>'
            }

            var latency = mcp.latency || {}

            if( latency.ping !== null && latency.ping !== undefined ) {
                var pingPct = Math.min( latency.ping / 5000 * 100, 100 )

                inner += '<div class="latency-bar">'
                inner += '<span class="latency-label">Ping Latency:</span>'
                inner += '<div class="latency-track"><div class="latency-fill" style="width:' + pingPct + '%"></div></div>'
                inner += '<span class="latency-value">' + latency.ping + ' ms</span>'
                inner += '</div>'
            }

            if( latency.listTools !== null && latency.listTools !== undefined ) {
                var toolsPct = Math.min( latency.listTools / 5000 * 100, 100 )

                inner += '<div class="latency-bar">'
                inner += '<span class="latency-label">Tools Latency:</span>'
                inner += '<div class="latency-track"><div class="latency-fill" style="width:' + toolsPct + '%"></div></div>'
                inner += '<span class="latency-value">' + latency.listTools + ' ms</span>'
                inner += '</div>'
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Core</h3>'
            inner += renderCategoryGrid( {
                'isReachable': cats.isReachable,
                'supportsMcp': cats.supportsMcp,
                'hasTools': cats.hasTools,
                'hasResources': cats.hasResources,
                'hasPrompts': cats.hasPrompts
            } )

            inner += '<h3 style="margin-top:16px">Capabilities</h3>'
            inner += renderCategoryGrid( {
                'supportsTasks': cats.supportsTasks,
                'supportsMcpApps': cats.supportsMcpApps,
                'supportsLogging': cats.supportsLogging,
                'supportsCompletions': cats.supportsCompletions,
                'supportsResourceSubscription': cats.supportsResourceSubscription,
                'supportsResourceListChanged': cats.supportsResourceListChanged,
                'supportsPromptListChanged': cats.supportsPromptListChanged,
                'supportsToolListChanged': cats.supportsToolListChanged,
                'supportsTaskList': cats.supportsTaskList,
                'supportsTaskCancel': cats.supportsTaskCancel,
                'supportsTaskAugmentedToolCall': cats.supportsTaskAugmentedToolCall,
                'hasExperimentalCapabilities': cats.hasExperimentalCapabilities,
                'supportsSampling': cats.supportsSampling,
                'supportsElicitation': cats.supportsElicitation
            } )

            if( mcp.experimentalCapabilities && mcp.experimentalCapabilities.length > 0 ) {
                inner += '<div class="field" style="margin-top:8px"><span class="label">Experimental:</span> <span>'

                mcp.experimentalCapabilities.forEach( function( key ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( mcp.taskCapabilities ) {
                inner += '<div class="field" style="margin-top:8px"><span class="label">Task Features:</span> <span>'

                if( mcp.taskCapabilities.list ) { inner += '<span class="badge badge-blue">list</span> ' }
                if( mcp.taskCapabilities.cancel ) { inner += '<span class="badge badge-blue">cancel</span> ' }
                if( mcp.taskCapabilities.augmentedToolCall ) { inner += '<span class="badge badge-blue">augmentedToolCall</span> ' }

                inner += '</span></div>'
            }

            if( mcp.tools && mcp.tools.length > 0 ) {
                inner += '<h3 style="margin-top:16px">Tools</h3>'
                inner += '<div class="tools-grid">'

                var x402ToolNames = {}

                if( mcp.x402 && mcp.x402.restrictedCalls ) {
                    mcp.x402.restrictedCalls.forEach( function( t ) {
                        x402ToolNames[ t.toolName || t.name || t ] = true
                    } )
                }

                var uiToolNames = {}

                if( ui && ui.uiLinkedTools ) {
                    ui.uiLinkedTools.forEach( function( t ) {
                        uiToolNames[ t.name || t ] = true
                    } )
                }

                mcp.tools.forEach( function( tool ) {
                    var toolName = tool.name || '-'
                    var isX402 = x402ToolNames[ toolName ] || false

                    if( !isX402 ) {
                        var str = JSON.stringify( tool ).toLowerCase()

                        isX402 = str.indexOf( 'x402' ) !== -1 ||
                            str.indexOf( 'paymentrequir' ) !== -1 ||
                            str.indexOf( 'payment_requir' ) !== -1
                    }

                    var isUI = uiToolNames[ toolName ] || false

                    var cls = isX402 ? 'tool-item x402-tool' : 'tool-item'

                    inner += '<div class="' + cls + '">'
                    inner += '<div class="tool-name">' + escapeHtml( toolName )

                    if( isX402 ) { inner += ' <span class="badge badge-green">x402</span>' }
                    if( isUI ) { inner += ' <span class="badge badge-purple">UI</span>' }

                    inner += '</div>'
                    inner += '<div class="tool-desc">' + escapeHtml( ( tool.description || '' ).substring( 0, 120 ) ) + '</div>'
                    inner += '</div>'
                } )

                inner += '</div>'
            }

            return wrapCollapsible( 'MCP Server', inner, true )
        }

        // ── A2A Detail ──

        function renderA2aDetail( a2a, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Agent Name:</span> <span>' + escapeHtml( a2a.agentName || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( a2a.agentDescription || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Version:</span> <span>' + escapeHtml( a2a.agentVersion || '-' ) + '</span></div>'

            if( a2a.provider && ( a2a.provider.organization || a2a.provider.url ) ) {
                var providerText = a2a.provider.organization || '-'

                inner += '<div class="field"><span class="label">Provider:</span> <span>'

                if( a2a.provider.url ) {
                    inner += '<a href="' + escapeHtml( a2a.provider.url ) + '" target="_blank" rel="noopener">' + escapeHtml( providerText ) + '</a>'
                } else {
                    inner += escapeHtml( providerText )
                }

                inner += '</span></div>'
            }

            inner += '<div class="field"><span class="label">Skills:</span> <span>' + ( a2a.skillCount || 0 ) + '</span></div>'

            if( a2a.skills && a2a.skills.length > 0 ) {
                inner += '<div class="field"><span class="label">Skill List:</span> <span>'

                a2a.skills.forEach( function( skill ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( skill.name || skill.id || '-' ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( a2a.protocolVersion ) {
                inner += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( a2a.protocolVersion ) + '</span></div>'
            }

            if( a2a.protocolBindings && a2a.protocolBindings.length > 0 ) {
                inner += '<div class="field"><span class="label">Protocol Bindings:</span> <span>'

                a2a.protocolBindings.forEach( function( binding ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( typeof binding === 'string' ? binding : JSON.stringify( binding ) ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( a2a.ap2Version || cats.supportsA2aAp2 ) {
                inner += '<div class="field"><span class="label">AP2:</span> <span>'
                inner += '<span class="badge badge-green">Detected</span> '

                if( a2a.ap2Version ) {
                    inner += '<span class="badge badge-blue">v' + escapeHtml( a2a.ap2Version ) + '</span>'
                }

                inner += '</span></div>'
            }

            if( a2a.ap2Roles && a2a.ap2Roles.length > 0 ) {
                inner += '<div class="field"><span class="label">AP2 Roles:</span> <span>'

                a2a.ap2Roles.forEach( function( role ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( role ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( a2a.x402Version || cats.supportsA2aX402 ) {
                inner += '<div class="field"><span class="label">x402 (A2A):</span> <span>'
                inner += '<span class="badge badge-green">Detected</span> '

                if( a2a.x402Version ) {
                    inner += '<span class="badge badge-blue">v' + escapeHtml( a2a.x402Version ) + '</span>'
                }

                inner += '</span></div>'
            }

            if( cats.supportsA2aEmbeddedFlow ) {
                inner += '<div class="field"><span class="label">Embedded Flow:</span> <span>'
                inner += '<span class="badge badge-green">AP2 + x402</span>'
                inner += '</span></div>'
            }

            if( a2a.erc8004ServiceUrl || cats.hasA2aErc8004ServiceLink ) {
                inner += '<div class="field"><span class="label">ERC-8004 Service:</span> <span>'

                if( a2a.erc8004ServiceUrl ) {
                    inner += '<a href="' + escapeHtml( a2a.erc8004ServiceUrl ) + '" target="_blank" rel="noopener">' + escapeHtml( a2a.erc8004ServiceUrl ) + '</a>'
                } else {
                    inner += '<span class="badge badge-green">Linked</span>'
                }

                inner += '</span></div>'
            }

            if( a2a.extensions && typeof a2a.extensions === 'object' && Object.keys( a2a.extensions ).length > 0 ) {
                inner += '<div class="field"><span class="label">Extensions:</span> <span>'

                Object.keys( a2a.extensions ).forEach( function( key ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'hasAgentCard': cats.hasA2aCard,
                'hasValidStructure': cats.hasA2aValidStructure,
                'hasSkills': cats.hasA2aSkills,
                'supportsStreaming': cats.supportsA2aStreaming,
                'hasSecuritySchemes': cats.hasA2aSecuritySchemes,
                'hasProvider': cats.hasA2aProvider,
                'supportsPushNotifications': cats.supportsA2aPushNotifications,
                'supportsJsonRpc': cats.supportsA2aJsonRpc,
                'supportsGrpc': cats.supportsA2aGrpc,
                'supportsExtendedCard': cats.supportsA2aExtendedCard,
                'hasDocumentation': cats.hasA2aDocumentation,
                'supportsAp2': cats.supportsA2aAp2,
                'supportsX402': cats.supportsA2aX402,
                'supportsEmbeddedFlow': cats.supportsA2aEmbeddedFlow,
                'hasErc8004ServiceLink': cats.hasA2aErc8004ServiceLink
            } )

            return wrapCollapsible( 'A2A Agent', inner, true )
        }

        // ── x402 Detail ──

        function renderX402Detail( x402, cats ) {
            var inner = '<div class="probe-summary">'

            if( x402.version !== null && x402.version !== undefined ) {
                inner += '<div class="field"><span class="label">x402 Version:</span> <span>v' + x402.version + '</span></div>'
            }

            var networks = x402.networks || []

            if( networks.length > 0 ) {
                inner += '<div class="field"><span class="label">Networks:</span> <span>'

                networks.forEach( function( n ) {
                    inner += '<span class="badge badge-green">' + escapeHtml( CHAIN_NAMES[ n ] || n ) + '</span> '
                } )

                inner += '</span></div>'
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                inner += '<div class="field"><span class="label">Schemes:</span> <span>'

                schemes.forEach( function( s ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( s ) + '</span> '
                } )

                inner += '</span></div>'
            }

            var perTool = x402.perTool || {}
            var perToolKeys = Object.keys( perTool )

            if( perToolKeys.length > 0 ) {
                inner += '</div>'
                inner += '<h3 style="margin-top:16px">Payment Options</h3>'

                var optionGroups = {}

                perToolKeys.forEach( function( toolName ) {
                    var toolData = perTool[ toolName ]
                    var toolNetworks = toolData.networks || []
                    var byNetwork = toolData.byNetwork || {}

                    toolNetworks.forEach( function( network ) {
                        var opt = byNetwork[ network ] || {}
                        var key = network + '|' + ( opt.scheme || '' ) + '|' + ( opt.payTo || '' )

                        if( !optionGroups[ key ] ) {
                            optionGroups[ key ] = { network: network, opt: opt, tools: [] }
                        }

                        optionGroups[ key ].tools.push( toolName )
                    } )
                } )

                Object.keys( optionGroups ).forEach( function( key ) {
                    var group = optionGroups[ key ]
                    var details = []

                    if( group.opt.scheme ) { details.push( 'Scheme: ' + group.opt.scheme ) }
                    if( group.opt.amount ) { details.push( 'Amount: ' + group.opt.amount ) }
                    if( group.opt.payTo ) { details.push( 'Pay to: ' + group.opt.payTo.substring( 0, 10 ) + '...' + group.opt.payTo.slice( -6 ) ) }
                    if( group.opt.maxTimeoutSeconds ) { details.push( 'Timeout: ' + group.opt.maxTimeoutSeconds + 's' ) }

                    inner += '<div class="payment-option-group">'
                    inner += '<div class="payment-option-header">'
                    inner += '<span class="badge badge-green">' + escapeHtml( chainLabel( group.network ) ) + '</span>'
                    inner += '</div>'
                    inner += '<div class="payment-option-details">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                    inner += '<div class="payment-option-tools">'
                    inner += '<span class="label">Tools (' + group.tools.length + '):</span> '

                    inner += group.tools.map( function( t ) {
                        return '<span class="tool-tag">' + escapeHtml( t ) + '</span>'
                    } ).join( ' ' )

                    inner += '</div>'
                    inner += '</div>'
                } )
            } else {
                var paymentOptions = x402.paymentOptions || []

                if( paymentOptions.length > 0 ) {
                    inner += '</div>'
                    inner += '<h3 style="margin-top:16px">Payment Requirements</h3>'
                    inner += '<div class="tools-grid">'

                    paymentOptions.forEach( function( pr ) {
                        inner += '<div class="tool-item x402-tool">'

                        if( pr.network ) { inner += '<div class="tool-name">' + escapeHtml( chainLabel( pr.network ) ) + '</div>' }

                        var details = []

                        if( pr.scheme ) { details.push( 'Scheme: ' + pr.scheme ) }
                        if( pr.maxAmountRequired ) { details.push( 'Max: ' + pr.maxAmountRequired ) }
                        if( pr.resource ) { details.push( 'Resource: ' + pr.resource ) }
                        if( pr.payTo ) { details.push( 'Pay to: ' + pr.payTo.substring( 0, 10 ) + '...' + pr.payTo.slice( -6 ) ) }

                        if( details.length > 0 ) {
                            inner += '<div class="tool-desc">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                        }

                        inner += '</div>'
                    } )

                    inner += '</div>'
                } else {
                    inner += '</div>'
                }
            }

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsX402': cats.supportsX402,
                'hasValidPaymentRequirements': cats.hasValidPaymentRequirements,
                'supportsExactScheme': cats.supportsExactScheme,
                'supportsEvm': cats.supportsEvm,
                'supportsSolana': cats.supportsSolana
            } )

            return wrapCollapsible( 'x402 Payment Support', inner, true )
        }

        // ── OAuth Detail ──

        function renderOAuthDetail( oauth, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Issuer:</span> <span>' + escapeHtml( oauth.issuer || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Authorization Endpoint:</span> <span>' + escapeHtml( oauth.authorizationEndpoint || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Token Endpoint:</span> <span>' + escapeHtml( oauth.tokenEndpoint || '-' ) + '</span></div>'

            if( oauth.registrationEndpoint ) {
                inner += '<div class="field"><span class="label">Registration Endpoint:</span> <span>' + escapeHtml( oauth.registrationEndpoint ) + '</span></div>'
            }

            if( oauth.grantTypesSupported && oauth.grantTypesSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">Grant Types:</span> <span>'

                oauth.grantTypesSupported.forEach( function( gt ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( gt ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( oauth.pkceMethodsSupported && oauth.pkceMethodsSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">PKCE Methods:</span> <span>'

                oauth.pkceMethodsSupported.forEach( function( m ) {
                    inner += '<span class="badge badge-green">' + escapeHtml( m ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( oauth.scopesSupported && oauth.scopesSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">Scopes:</span> <span>'

                oauth.scopesSupported.forEach( function( s ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( s ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsOAuth': cats.supportsOAuth,
                'hasProtectedResourceMetadata': cats.hasProtectedResourceMetadata,
                'hasAuthServerMetadata': cats.hasAuthServerMetadata,
                'supportsPkce': cats.supportsPkce,
                'hasDynamicRegistration': cats.hasDynamicRegistration,
                'hasValidOAuthConfig': cats.hasValidOAuthConfig
            } )

            return wrapCollapsible( 'OAuth / Authorization', inner, true )
        }

        // ── MCP Apps Detail ──

        function renderMcpAppsDetail( ui, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Extension Version:</span> <span>' + escapeHtml( ui.extensionVersion || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">UI Resources:</span> <span>' + ( ui.uiResourceCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Linked Tools:</span> <span>' + ( ui.uiLinkedToolCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">App-Only Tools:</span> <span>' + ( ui.appOnlyToolCount || 0 ) + '</span></div>'

            if( ui.displayModes && ui.displayModes.length > 0 ) {
                inner += '<div class="field"><span class="label">Display Modes:</span> <span>'

                ui.displayModes.forEach( function( mode ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( mode ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( ui.permissionsSummary && ui.permissionsSummary.length > 0 ) {
                inner += '<div class="field"><span class="label">Permissions:</span> <span>'

                ui.permissionsSummary.forEach( function( perm ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( perm ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsMcpApps': cats.uiSupportsMcpApps,
                'hasUiResources': cats.uiHasUiResources,
                'hasToolLinkage': cats.uiHasToolLinkage,
                'hasValidHtml': cats.uiHasValidHtml,
                'hasValidCsp': cats.uiHasValidCsp,
                'supportsTheming': cats.uiSupportsTheming
            } )

            if( ui.uiResources && ui.uiResources.length > 0 ) {
                inner += '<h3 style="margin-top:16px">UI Resources</h3>'
                inner += '<div class="tools-grid">'

                ui.uiResources.forEach( function( res ) {
                    inner += '<div class="tool-item">'
                    inner += '<div class="tool-name">' + escapeHtml( res.uri || res.name || '-' ) + '</div>'

                    var parts = []

                    if( res.mimeType ) { parts.push( res.mimeType ) }
                    if( res.hasCsp ) { parts.push( 'CSP' ) }
                    if( res.displayModes && res.displayModes.length > 0 ) { parts.push( res.displayModes.join( ', ' ) ) }

                    if( parts.length > 0 ) {
                        inner += '<div class="tool-desc">' + escapeHtml( parts.join( ' · ' ) ) + '</div>'
                    }

                    inner += '</div>'
                } )

                inner += '</div>'
            }

            if( ui.uiLinkedTools && ui.uiLinkedTools.length > 0 ) {
                inner += '<h3 style="margin-top:16px">UI-Linked Tools</h3>'
                inner += '<div class="tools-grid">'

                ui.uiLinkedTools.forEach( function( tool ) {
                    inner += '<div class="tool-item">'
                    inner += '<div class="tool-name">' + escapeHtml( tool.name || '-' )

                    if( tool.visibility ) {
                        inner += ' <span class="badge badge-purple">' + escapeHtml( Array.isArray( tool.visibility ) ? tool.visibility.join( ', ' ) : tool.visibility ) + '</span>'
                    }

                    inner += '</div>'

                    if( tool.resourceUri ) {
                        inner += '<div class="tool-desc">' + escapeHtml( tool.resourceUri ) + '</div>'
                    }

                    inner += '</div>'
                } )

                inner += '</div>'
            }

            return wrapCollapsible( 'MCP Apps', inner, true )
        }

        // ── Validation Messages ──

        function renderMessages( messages ) {
            var inner = ''

            var errors = messages.filter( function( m ) { return m.severity === 'ERROR' } )
            var warnings = messages.filter( function( m ) { return m.severity === 'WARNING' } )
            var infos = messages.filter( function( m ) { return m.severity === 'INFO' } )

            if( errors.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#f04">Errors (' + errors.length + ')</h4>'
                inner += '<ul class="messages-list">'

                errors.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            if( warnings.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#fa0">Warnings (' + warnings.length + ')</h4>'
                inner += '<ul class="messages-list">'

                warnings.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            if( infos.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#888">Info (' + infos.length + ')</h4>'
                inner += '<ul class="messages-list">'

                infos.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            return wrapCollapsible( 'Validation Messages', inner, false )
        }

        // ── Validate Action ──

        async function validate() {
            var urlInput = document.getElementById( 'urlInput' )
            var rawUrl = urlInput.value.trim()

            if( !rawUrl ) {
                showError( 'Please enter an endpoint URL.' )

                return
            }

            if( rawUrl.indexOf( '://' ) === -1 ) {
                rawUrl = 'https://' + rawUrl
            }

            try {
                new URL( rawUrl )
            } catch( _e ) {
                showError( 'Invalid URL. Please enter a valid URL (e.g. https://example.com).' )

                return
            }

            setValidatorState( 'loading' )
            setLoadingText( 'Probing MCP, A2A, x402, OAuth, MCP Apps (server-side)...' )

            try {
                var response = await fetch( '/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { url: rawUrl } )
                } )

                var data = await response.json()

                if( data.error ) {
                    setValidatorState( 'idle' )
                    showError( data.error )

                    return
                }

                renderVerdicts( data )
                renderDetails( data )
                renderRawAssessment( data, rawUrl )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        // ── Adapt Lookup Response ──

        function parseRawEndpoints( raw ) {
            if( !raw ) { return null }

            try {
                var parsed = typeof raw === 'string' ? JSON.parse( raw ) : raw

                return parsed.endpoints || null
            } catch( _e ) {
                return null
            }
        }

        function parseRawMetadata( raw ) {
            if( !raw ) { return null }

            try {
                var parsed = typeof raw === 'string' ? JSON.parse( raw ) : raw

                return {
                    image: parsed.image || null,
                    tags: parsed.tags || null,
                    oasfSkills: parsed.oasf_skills || null,
                    oasfDomains: parsed.oasf_domains || null,
                    type: parsed.type || null
                }
            } catch( _e ) {
                return null
            }
        }

        function adaptLookupResponse( lookupData ) {
            var r = lookupData.result || {}
            var entries = r.entries || {}
            var rep = r.reputation && r.reputation.feedbackCount !== null ? r.reputation : null
            var rawEndpoints = parseRawEndpoints( entries.raw )
            var rawMeta = parseRawMetadata( entries.raw )

            return {
                status: lookupData.status,
                categories: {
                    isHttpReachable: null,
                    supportsMcp: false,
                    hasA2aCard: false,
                    supportsX402: false,
                    supportsOAuth: false,
                    uiSupportsMcpApps: false,
                    hasWellKnownRegistration: false,
                    hasErc8004Registration: r.isOnChainVerified || false,
                    isErc8004OnChainVerified: r.isOnChainVerified || false,
                    isErc8004SpecCompliant: r.isSpecCompliant || false,
                    hasOnChainReputation: rep !== null
                },
                entries: {
                    http: null,
                    mcp: null,
                    a2a: null,
                    ui: null,
                    erc8004: {
                        agentId: r.agentId,
                        agentRegistry: '0x8004a169fb4a3325136eb29fa0ceb6d2e539a432',
                        chainAlias: r.chainAlias,
                        chainId: r.chainId,
                        registrationName: entries.name || null,
                        registrationDescription: entries.description || null,
                        isOnChainVerified: r.isOnChainVerified || false,
                        isSpecCompliant: r.isSpecCompliant || false,
                        x402Support: r.x402Support,
                        isActive: r.isActive,
                        services: r.services,
                        endpoints: rawEndpoints,
                        image: entries.image || ( rawMeta ? rawMeta.image : null ),
                        supportedTrust: r.supportedTrust || ( entries.supportedTrust || null ),
                        tags: rawMeta ? rawMeta.tags : null,
                        oasfSkills: rawMeta ? rawMeta.oasfSkills : null,
                        oasfDomains: rawMeta ? rawMeta.oasfDomains : null,
                        owner: r.owner || entries.ownerAddress || null,
                        agentUri: r.agentUri || null,
                        uriType: entries.uriAgentType || ( r.categories && r.categories.isBase64 ? 'base64' : r.categories && r.categories.isHttp ? 'http' : null )
                    },
                    reputation: rep,
                    assessment: null
                },
                messages: ( lookupData.messages || [] ).map( function( msg ) {
                    var severity = 'INFO'

                    if( msg.indexOf( 'LKP-0' ) === 0 ) { severity = 'WARNING' }
                    if( msg.indexOf( 'LKP-01' ) === 0 || msg.indexOf( 'LKP-02' ) === 0 ) { severity = 'ERROR' }

                    return { severity: severity, message: msg }
                } )
            }
        }

        // ── Lookup Action ──

        async function lookup() {
            var input = document.getElementById( 'agentIdInput' )
            var agentId = input.value.trim()

            if( !agentId ) {
                showError( 'Please enter an agent ID.' )

                return
            }

            var chainId = Number( document.getElementById( 'chainSelect' ).value )

            setValidatorState( 'loading' )
            setLoadingText( 'Looking up agent #' + agentId + ' on-chain...' )

            try {
                var response = await fetch( '/api/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { agentId: Number( agentId ), chainId: chainId } )
                } )

                var raw = await response.json()

                if( raw.error ) {
                    setValidatorState( 'idle' )
                    showError( raw.error )

                    return
                }

                var data = adaptLookupResponse( raw )

                renderVerdicts( data )
                renderDetails( data )
                renderRawAssessment( raw, 'agent:#' + agentId + '@' + chainId )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        // ── Event Listeners ──

        document.getElementById( 'urlInput' ).addEventListener( 'keydown', function( e ) {
            if( e.key === 'Enter' ) { validate() }
        } )

        document.getElementById( 'agentIdInput' ).addEventListener( 'keydown', function( e ) {
            if( e.key === 'Enter' ) { lookup() }
        } )

        document.querySelectorAll( '.example-link' ).forEach( function( link ) {
            link.addEventListener( 'click', function( e ) {
                e.preventDefault()
                var input = document.getElementById( 'urlInput' )
                var url = link.getAttribute( 'data-url' )

                input.value = url === 'self' ? window.location.origin + '/mcp' : url
                validate()
            } )
        } )

        document.querySelectorAll( '.lookup-example' ).forEach( function( link ) {
            link.addEventListener( 'click', function( e ) {
                e.preventDefault()
                var input = document.getElementById( 'agentIdInput' )
                var chainSelect = document.getElementById( 'chainSelect' )
                var chain = link.getAttribute( 'data-chain' )

                input.value = link.getAttribute( 'data-id' )

                if( chain ) {
                    chainSelect.value = chain
                    localStorage.setItem( 'mcpValidator_chainId', chain )
                }

                switchTab( 'lookup' )
                lookup()
            } )
        } )

        // Restore last chain selection
        var savedChain = localStorage.getItem( 'mcpValidator_chainId' )

        if( savedChain ) {
            var chainSelect = document.getElementById( 'chainSelect' )

            Array.from( chainSelect.options ).forEach( function( opt ) {
                if( opt.value === savedChain ) {
                    chainSelect.value = savedChain
                }
            } )
        }

        document.getElementById( 'chainSelect' ).addEventListener( 'change', function() {
            localStorage.setItem( 'mcpValidator_chainId', this.value )
        } )

        // ── Dependency Footer ──

        function loadDependencyInfo() {
            fetch( '/api/info' )
                .then( function( res ) { return res.json() } )
                .then( function( info ) {
                    var container = document.getElementById( 'depInfo' )

                    if( !info.dependencies || info.dependencies.length === 0 ) {
                        return
                    }

                    var links = info.dependencies
                        .map( function( dep ) {
                            if( !dep.shortHash || !dep.commitUrl ) {
                                return '<span class="dep-link">' + escapeHtml( dep.name ) + '</span>'
                            }

                            return '<a class="dep-link" href="' + escapeHtml( dep.commitUrl ) + '" target="_blank" rel="noopener">' +
                                escapeHtml( dep.name ) + ' <span class="dep-hash">' + escapeHtml( dep.shortHash ) + '</span></a>'
                        } )
                        .join( ' &middot; ' )

                    container.innerHTML = '<span class="dep-info-label">Validation modules</span>' + links
                } )
                .catch( function() {} )
        }

        loadDependencyInfo()

        // ── Raw Assessment Viewer ──

        function renderRawAssessment( data, url ) {
            var container = document.getElementById( 'rawAssessmentSection' )
            var jsonStr = JSON.stringify( data, null, 2 )

            var hostname = ''

            try {
                hostname = new URL( url ).hostname
            } catch( _e ) {
                hostname = url.replace( /[^a-zA-Z0-9\-_#]/g, '_' ) || 'unknown'
            }

            var timestamp = new Date().toISOString().replace( /[:.]/g, '-' ).slice( 0, 19 )
            var filename = 'assessment-' + hostname + '-' + timestamp + '.json'

            var html = '<div class="detail-section">' +
                '<div class="section-toggle" onclick="toggleSection(this)">' +
                '<span class="section-arrow">\u25B6</span>' +
                '<h3>Raw Assessment</h3>' +
                '</div>' +
                '<div class="section-content" style="display:none">' +
                '<div class="raw-actions">' +
                '<button class="raw-btn" id="rawCopyBtn">Copy</button>' +
                '<button class="raw-btn" id="rawDownloadBtn">Download</button>' +
                '</div>' +
                '<pre><code>' + escapeHtml( jsonStr ) + '</code></pre>' +
                '</div>' +
                '</div>'

            container.innerHTML = html

            document.getElementById( 'rawCopyBtn' ).addEventListener( 'click', function() {
                var btn = this

                navigator.clipboard.writeText( jsonStr ).then( function() {
                    btn.textContent = 'Copied!'
                    setTimeout( function() { btn.textContent = 'Copy' }, 2000 )
                } )
            } )

            document.getElementById( 'rawDownloadBtn' ).addEventListener( 'click', function() {
                var blob = new Blob( [ jsonStr ], { type: 'application/json' } )
                var a = document.createElement( 'a' )

                a.href = URL.createObjectURL( blob )
                a.download = filename
                document.body.appendChild( a )
                a.click()
                document.body.removeChild( a )
                URL.revokeObjectURL( a.href )
            } )
        }

    </script>
</body>
</html>
