<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Agent Validator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>MCP Agent Validator</h1>
            <p class="subtitle">Multi-protocol endpoint assessment: MCP, A2A, x402, OAuth, MCP Apps, ERC-8004</p>
        </header>

        <div>
            <div class="validator-input">
                <input type="text" id="urlInput" placeholder="Enter endpoint URL or agent ID" spellcheck="false">
                <button class="validator-btn" id="validateBtn">Validate</button>
            </div>

            <div class="chain-selector" id="chainSelector" style="display:none">
                <label for="chainSelect">Chain:</label>
                <select id="chainSelect">
                    <option value="84532">Base Sepolia (84532)</option>
                    <option value="11155111">Sepolia (11155111)</option>
                    <option value="8453">Base (8453)</option>
                    <option value="1">Ethereum (1)</option>
                    <option value="10">Optimism (10)</option>
                    <option value="137">Polygon (137)</option>
                    <option value="42161">Arbitrum (42161)</option>
                </select>
            </div>

            <div class="input-hint" id="inputHint">Accepts endpoint URLs or ERC-8004 agent IDs (numeric)</div>

            <div class="example-urls">
                <span>Try:</span>
                <a data-url="https://x402.flowmcp.org/mcp/streamable">x402.flowmcp.org/mcp/streamable</a>
                <a data-url="https://blackjack.nanobot.ai/mcp">blackjack.nanobot.ai/mcp</a>
                <a data-url="#1" data-type="agent">Agent #1</a>
            </div>

            <div class="error-message" id="errorBox"></div>

            <div class="loading-section" id="loadingSection">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">Probing endpoint...</div>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="verdict-grid" id="verdictGrid"></div>
                <div id="detailSections"></div>
            </div>

            <div id="rawAssessmentSection" class="raw-assessment-section" style="display:none"></div>
        </div>

        <footer>
            <a href="https://github.com/FlowMCP/mcp-agent-validator">mcp-agent-validator</a> &middot;
            Server-side validation via Node.js probes
            <div id="depInfo" class="dep-info"></div>
        </footer>
    </div>

    <script>
        // ── Chain Name Mapping ──

        var CHAIN_NAMES = {
            'eip155:1': 'Ethereum',
            'eip155:10': 'Optimism',
            'eip155:137': 'Polygon',
            'eip155:42161': 'Arbitrum',
            'eip155:8453': 'Base',
            'eip155:43113': 'Avalanche Fuji',
            'eip155:11155111': 'Ethereum Sepolia',
            'eip155:84532': 'Base Sepolia',
            'eip155:421614': 'Arbitrum Sepolia',
            'eip155:11155420': 'Optimism Sepolia',
            'solana:mainnet': 'Solana',
            'solana:devnet': 'Solana Devnet'
        }

        function chainLabel( caip2 ) {
            var name = CHAIN_NAMES[ caip2 ]

            return name ? caip2 + ' (' + name + ')' : caip2
        }

        // ── Helpers ──

        function escapeHtml( str ) {
            var div = document.createElement( 'div' )
            div.textContent = str

            return div.innerHTML
        }

        function show( el ) { el.style.display = 'block' }
        function hide( el ) { el.style.display = 'none' }

        function toggleSection( toggleEl ) {
            var content = toggleEl.nextElementSibling
            var arrow = toggleEl.querySelector( '.section-arrow' )

            if( content.style.display === 'none' ) {
                content.style.display = 'block'
                arrow.textContent = '\u25BC'
            } else {
                content.style.display = 'none'
                arrow.textContent = '\u25B6'
            }
        }

        function wrapCollapsible( title, innerHtml, defaultOpen ) {
            var arrow = defaultOpen ? '\u25BC' : '\u25B6'
            var display = defaultOpen ? 'block' : 'none'

            return '<div class="detail-section">' +
                '<div class="section-toggle" onclick="toggleSection(this)">' +
                '<span class="section-arrow">' + arrow + '</span>' +
                '<h3>' + escapeHtml( title ) + '</h3>' +
                '</div>' +
                '<div class="section-content" style="display:' + display + '">' +
                innerHtml +
                '</div>' +
                '</div>'
        }

        function renderCategoryGrid( obj ) {
            var html = '<div class="categories-grid">'

            Object.keys( obj ).forEach( function( key ) {
                var val = obj[ key ]

                if( val === null || val === undefined ) { return }

                var icon = val
                    ? '<span class="check-yes">&#10003;</span>'
                    : '<span class="check-no">&#10005;</span>'

                html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
            } )

            html += '</div>'

            return html
        }

        // ── State Management ──

        function setValidatorState( state ) {
            var loading = document.getElementById( 'loadingSection' )
            var results = document.getElementById( 'resultsSection' )
            var rawSection = document.getElementById( 'rawAssessmentSection' )
            var errorBox = document.getElementById( 'errorBox' )
            var btn = document.getElementById( 'validateBtn' )

            hide( loading )
            hide( results )
            hide( rawSection )
            hide( errorBox )
            btn.disabled = false

            if( state === 'loading' ) {
                show( loading )
                btn.disabled = true
            } else if( state === 'results' ) {
                show( results )
                show( rawSection )
            }
        }

        function showError( msg ) {
            var errorBox = document.getElementById( 'errorBox' )
            errorBox.textContent = msg
            show( errorBox )
        }

        function setLoadingText( text ) {
            document.getElementById( 'loadingText' ).textContent = text
        }

        // ── x402 Detail Helper ──

        function buildX402Detail( x402 ) {
            if( !x402 ) { return 'Supported' }

            var restrictedCalls = x402.restrictedCalls || []

            if( restrictedCalls.length > 0 ) {
                return restrictedCalls.length + ' payment tool' + ( restrictedCalls.length !== 1 ? 's' : '' )
            }

            var parts = []
            var networks = x402.networks || []

            if( networks.length > 0 ) {
                parts.push( networks.length + ' network' + ( networks.length !== 1 ? 's' : '' ) )
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                parts.push( schemes.join( ', ' ) )
            }

            return parts.length > 0 ? parts.join( ' · ' ) : 'Supported'
        }

        // ── Verdict Cards ──

        function renderVerdicts( data ) {
            var grid = document.getElementById( 'verdictGrid' )
            var cats = data.categories
            var http = data.entries.http
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var x402 = mcp ? mcp.x402 : null
            var oauth = mcp ? mcp.oauth : null
            var assessment = data.entries.assessment
            var summary = data.summary || {}

            var cards = [
                {
                    label: 'HTTP',
                    pass: cats.isHttpReachable,
                    detail: cats.isHttpReachable
                        ? ( cats.isHttps ? 'HTTPS' : 'HTTP' ) + ' · ' + ( summary.httpStatusCode || ( http ? http.statusCode : '-' ) ) + ( http && http.responseTimeMs !== null ? ' · ' + http.responseTimeMs + 'ms' : '' )
                        : 'Not reachable'
                },
                {
                    label: 'MCP',
                    pass: cats.supportsMcp,
                    detail: cats.supportsMcp
                        ? ( mcp.serverName || 'MCP Server' ) + ' (' + ( mcp.toolCount || 0 ) + ' tools)'
                        : 'Not detected'
                },
                {
                    label: 'A2A / AP2',
                    pass: cats.hasA2aCard,
                    detail: cats.hasA2aCard
                        ? ( a2a ? ( a2a.agentName || 'A2A Agent' ) : 'A2A Agent' )
                        : 'Not detected'
                },
                {
                    label: 'x402',
                    pass: cats.supportsX402,
                    detail: cats.supportsX402
                        ? buildX402Detail( x402 )
                        : 'Not detected'
                },
                {
                    label: 'OAuth',
                    pass: cats.supportsOAuth,
                    detail: cats.supportsOAuth
                        ? ( oauth ? ( oauth.issuer || 'OAuth detected' ) : 'OAuth detected' )
                        : 'Not required'
                },
                {
                    label: 'MCP Apps',
                    pass: cats.uiSupportsMcpApps,
                    detail: cats.uiSupportsMcpApps
                        ? ( ui ? ( ui.uiResourceCount + ' UI resource' + ( ui.uiResourceCount !== 1 ? 's' : '' ) ) : 'Detected' )
                        : 'Not detected'
                },
                {
                    label: 'ERC-8004',
                    pass: cats.hasErc8004Registration || cats.hasWellKnownRegistration,
                    detail: ( function() {
                        if( !cats.hasErc8004Registration && !cats.hasWellKnownRegistration ) { return 'Not registered' }
                        if( !cats.hasErc8004Registration ) { return 'Well-known found' }
                        var parts = [ 'On-chain' ]
                        if( cats.isErc8004OnChainVerified ) { parts.push( 'Verified' ) }
                        var e = data.entries.erc8004
                        if( e && e.chainAlias ) { parts.push( CHAIN_NAMES[ e.chainAlias ] || e.chainAlias ) }
                        return parts.join( ' · ' )
                    } )()
                }
            ]

            grid.innerHTML = cards.map( function( card ) {
                var cls = card.pass ? 'pass' : 'fail'
                var icon = card.pass
                    ? '<span class="check-yes" style="font-size:28px">&#10003;</span>'
                    : '<span class="check-no" style="font-size:28px">&#10005;</span>'

                return '<div class="verdict-card ' + cls + '">' +
                    '<div class="verdict-icon">' + icon + '</div>' +
                    '<div class="verdict-label">' + escapeHtml( card.label ) + '</div>' +
                    '<div class="verdict-detail">' + escapeHtml( card.detail ) + '</div>' +
                    '</div>'
            } ).join( '' )
        }

        // ── Detail Sections ──

        function renderDetails( data ) {
            var container = document.getElementById( 'detailSections' )
            var cats = data.categories
            var http = data.entries.http
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var erc8004 = data.entries.erc8004
            var reputation = data.entries.reputation
            var html = ''

            if( http ) {
                html += renderHttpDetail( http, cats )
            }

            if( cats.supportsMcp && mcp ) {
                html += renderMcpDetail( mcp, cats, ui )
            }

            if( cats.hasA2aCard && a2a ) {
                html += renderA2aDetail( a2a, cats )
            }

            if( cats.supportsX402 && mcp && mcp.x402 ) {
                html += renderX402Detail( mcp.x402, cats )
            }

            if( cats.supportsOAuth && mcp && mcp.oauth ) {
                html += renderOAuthDetail( mcp.oauth, cats )
            }

            if( cats.uiSupportsMcpApps && ui ) {
                html += renderMcpAppsDetail( ui, cats )
            }

            if( erc8004 || cats.hasWellKnownRegistration || cats.hasErc8004Registration ) {
                html += renderErc8004Detail( erc8004, reputation, cats )
            }

            if( data.messages && data.messages.length > 0 ) {
                html += renderMessages( data.messages )
            }

            container.innerHTML = html
        }

        // ── HTTP Detail ──

        function renderHttpDetail( http, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Protocol:</span> <span>' + escapeHtml( http.protocol || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Status Code:</span> <span>' + ( http.statusCode || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Response Time:</span> <span>' + ( http.responseTimeMs !== null ? http.responseTimeMs + ' ms' : '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Content-Type:</span> <span>' + escapeHtml( http.contentType || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">IP Address:</span> <span>' + escapeHtml( http.ipAddress || '-' ) + '</span></div>'

            if( http.serverHeader ) {
                inner += '<div class="field"><span class="label">Server:</span> <span>' + escapeHtml( http.serverHeader ) + '</span></div>'
            }

            if( cats.isHttps ) {
                inner += '<div class="field"><span class="label">TLS Version:</span> <span>' + escapeHtml( http.sslProtocol || '-' ) + '</span></div>'

                if( http.sslIssuer ) {
                    inner += '<div class="field"><span class="label">SSL Issuer:</span> <span>' + escapeHtml( http.sslIssuer ) + '</span></div>'
                }

                if( http.sslExpiresAt ) {
                    inner += '<div class="field"><span class="label">SSL Expires:</span> <span>' + escapeHtml( http.sslExpiresAt ) + '</span></div>'
                }
            }

            if( http.redirectChain && http.redirectChain.length > 0 ) {
                inner += '<div class="field"><span class="label">Redirects:</span> <span>' + http.redirectCount + '</span></div>'

                http.redirectChain.forEach( function( r ) {
                    inner += '<div class="field" style="padding-left:16px"><span class="label">' + r.statusCode + '</span> <span>'
                    inner += escapeHtml( r.from ) + ' &rarr; ' + escapeHtml( r.to )
                    inner += '</span></div>'
                } )
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'isHttpReachable': cats.isHttpReachable,
                'isHttps': cats.isHttps,
                'hasValidSsl': cats.hasValidSsl,
                'hasSslCertificate': cats.hasSslCertificate,
                'hasRedirects': cats.hasRedirects,
                'isWebsite': cats.isWebsite,
                'isApiEndpoint': cats.isApiEndpoint,
                'hasServerHeader': cats.hasServerHeader,
                'supportsCors': cats.supportsCors,
                'supportsHttp2': cats.supportsHttp2
            } )

            return wrapCollapsible( 'HTTP / HTTPS', inner, false )
        }

        // ── ERC-8004 Chain Names ──

        var CHAIN_NAMES = {
            'ETHEREUM_MAINNET': 'Ethereum',
            'OPTIMISM_MAINNET': 'Optimism',
            'BNB_MAINNET': 'BNB Smart Chain',
            'GNOSIS_MAINNET': 'Gnosis',
            'POLYGON_MAINNET': 'Polygon',
            'MONAD_MAINNET': 'Monad',
            'XLAYER_MAINNET': 'XLayer',
            'BASE_MAINNET': 'Base',
            'ARBITRUM_MAINNET': 'Arbitrum',
            'CELO_MAINNET': 'Celo',
            'AVALANCHE_MAINNET': 'Avalanche',
            'LINEA_MAINNET': 'Linea',
            'TAIKO_MAINNET': 'Taiko',
            'SCROLL_MAINNET': 'Scroll',
            'SEPOLIA_TESTNET': 'Sepolia',
            'BASE_SEPOLIA_TESTNET': 'Base Sepolia'
        }

        // ── ERC-8004 Detail ──

        function renderErc8004Detail( erc8004, reputation, cats ) {
            var inner = '<div class="probe-summary">'

            if( erc8004 ) {
                inner += '<div class="field"><span class="label">Agent ID:</span> <span>' + escapeHtml( String( erc8004.agentId ) ) + '</span></div>'
                inner += '<div class="field"><span class="label">Registry:</span> <span style="font-family:monospace;font-size:12px">' + escapeHtml( erc8004.agentRegistry || '-' ) + '</span></div>'
                var chainDisplayName = CHAIN_NAMES[ erc8004.chainAlias ] || erc8004.chainAlias || '-'
                inner += '<div class="field"><span class="label">Chain:</span> <span>' + escapeHtml( chainDisplayName ) + ( erc8004.chainId ? ' (' + erc8004.chainId + ')' : '' ) + '</span></div>'

                if( erc8004.registrationName ) {
                    inner += '<div class="field"><span class="label">Name:</span> <span>' + escapeHtml( erc8004.registrationName ) + '</span></div>'
                }

                if( erc8004.registrationDescription ) {
                    inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( erc8004.registrationDescription ) + '</span></div>'
                }

                inner += '<div class="field"><span class="label">On-Chain Verified:</span> <span>' + ( erc8004.isOnChainVerified ? 'Yes' : 'No' ) + '</span></div>'
                inner += '<div class="field"><span class="label">Spec Compliant:</span> <span>' + ( erc8004.isSpecCompliant ? 'Yes' : 'No' ) + '</span></div>'

                if( erc8004.x402Support !== null ) {
                    inner += '<div class="field"><span class="label">x402 Support:</span> <span>' + ( erc8004.x402Support ? 'Yes' : 'No' ) + '</span></div>'
                }

                if( erc8004.isActive !== null ) {
                    inner += '<div class="field"><span class="label">Active:</span> <span>' + ( erc8004.isActive ? 'Yes' : 'No' ) + '</span></div>'
                }

                if( erc8004.services && erc8004.services.length > 0 ) {
                    inner += '<div class="field"><span class="label">Services:</span> <span>' + erc8004.services.length + '</span></div>'

                    erc8004.services.forEach( function( svc ) {
                        inner += '<div class="field" style="padding-left:16px"><span class="label">' + escapeHtml( svc.type || 'service' ) + '</span> <span>'
                        inner += escapeHtml( svc.endpoint || svc.url || '-' )
                        inner += '</span></div>'
                    } )
                }
            } else {
                inner += '<div class="field"><span class="label">Status:</span> <span>No on-chain registration found</span></div>'
            }

            if( reputation ) {
                inner += '<h3 style="margin-top:16px">On-Chain Reputation</h3>'

                if( reputation.feedbackCount !== null ) {
                    inner += '<div class="field"><span class="label">Feedback Count:</span> <span>' + reputation.feedbackCount + '</span></div>'
                }

                if( reputation.averageValue !== null ) {
                    inner += '<div class="field"><span class="label">Average Value:</span> <span>' + reputation.averageValue + '</span></div>'
                }

                if( reputation.validationCount !== null ) {
                    inner += '<div class="field"><span class="label">Validation Count:</span> <span>' + reputation.validationCount + '</span></div>'
                }

                if( reputation.averageResponse !== null ) {
                    inner += '<div class="field"><span class="label">Avg Response:</span> <span>' + reputation.averageResponse + '</span></div>'
                }
            }

            inner += '</div>'

            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'hasWellKnownRegistration': cats.hasWellKnownRegistration,
                'hasErc8004Registration': cats.hasErc8004Registration,
                'isErc8004OnChainVerified': cats.isErc8004OnChainVerified,
                'isErc8004SpecCompliant': cats.isErc8004SpecCompliant,
                'hasOnChainReputation': cats.hasOnChainReputation
            } )

            return wrapCollapsible( 'ERC-8004 / Reputation', inner, true )
        }

        // ── MCP Detail ──

        function renderMcpDetail( mcp, cats, ui ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Server Name:</span> <span>' + escapeHtml( mcp.serverName || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Server Version:</span> <span>' + escapeHtml( mcp.serverVersion || '-' ) + '</span></div>'

            if( mcp.serverDescription ) {
                inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( mcp.serverDescription ) + '</span></div>'
            }

            if( mcp.protocolVersion ) {
                inner += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( mcp.protocolVersion ) + '</span></div>'
            }

            inner += '<div class="field"><span class="label">Tools:</span> <span>' + ( mcp.toolCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Resources:</span> <span>' + ( mcp.resourceCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Prompts:</span> <span>' + ( mcp.promptCount || 0 ) + '</span></div>'

            if( mcp.instructions ) {
                inner += '<div class="field"><span class="label">Instructions:</span> <span>' + escapeHtml( mcp.instructions.substring( 0, 200 ) ) + ( mcp.instructions.length > 200 ? '...' : '' ) + '</span></div>'
            }

            var latency = mcp.latency || {}

            if( latency.ping !== null && latency.ping !== undefined ) {
                var pingPct = Math.min( latency.ping / 5000 * 100, 100 )

                inner += '<div class="latency-bar">'
                inner += '<span class="latency-label">Ping Latency:</span>'
                inner += '<div class="latency-track"><div class="latency-fill" style="width:' + pingPct + '%"></div></div>'
                inner += '<span class="latency-value">' + latency.ping + ' ms</span>'
                inner += '</div>'
            }

            if( latency.listTools !== null && latency.listTools !== undefined ) {
                var toolsPct = Math.min( latency.listTools / 5000 * 100, 100 )

                inner += '<div class="latency-bar">'
                inner += '<span class="latency-label">Tools Latency:</span>'
                inner += '<div class="latency-track"><div class="latency-fill" style="width:' + toolsPct + '%"></div></div>'
                inner += '<span class="latency-value">' + latency.listTools + ' ms</span>'
                inner += '</div>'
            }

            inner += '</div>'

            // Core categories
            inner += '<h3 style="margin-top:16px">Core</h3>'
            inner += renderCategoryGrid( {
                'isReachable': cats.isReachable,
                'supportsMcp': cats.supportsMcp,
                'hasTools': cats.hasTools,
                'hasResources': cats.hasResources,
                'hasPrompts': cats.hasPrompts
            } )

            // Extended capabilities
            inner += '<h3 style="margin-top:16px">Capabilities</h3>'
            inner += renderCategoryGrid( {
                'supportsTasks': cats.supportsTasks,
                'supportsMcpApps': cats.supportsMcpApps,
                'supportsLogging': cats.supportsLogging,
                'supportsCompletions': cats.supportsCompletions,
                'supportsResourceSubscription': cats.supportsResourceSubscription,
                'supportsResourceListChanged': cats.supportsResourceListChanged,
                'supportsPromptListChanged': cats.supportsPromptListChanged,
                'supportsToolListChanged': cats.supportsToolListChanged,
                'supportsTaskList': cats.supportsTaskList,
                'supportsTaskCancel': cats.supportsTaskCancel,
                'supportsTaskAugmentedToolCall': cats.supportsTaskAugmentedToolCall,
                'hasExperimentalCapabilities': cats.hasExperimentalCapabilities,
                'supportsSampling': cats.supportsSampling,
                'supportsElicitation': cats.supportsElicitation
            } )

            if( mcp.experimentalCapabilities && mcp.experimentalCapabilities.length > 0 ) {
                inner += '<div class="field" style="margin-top:8px"><span class="label">Experimental:</span> <span>'

                mcp.experimentalCapabilities.forEach( function( key ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( mcp.taskCapabilities ) {
                inner += '<div class="field" style="margin-top:8px"><span class="label">Task Features:</span> <span>'

                if( mcp.taskCapabilities.list ) { inner += '<span class="badge badge-blue">list</span> ' }
                if( mcp.taskCapabilities.cancel ) { inner += '<span class="badge badge-blue">cancel</span> ' }
                if( mcp.taskCapabilities.augmentedToolCall ) { inner += '<span class="badge badge-blue">augmentedToolCall</span> ' }

                inner += '</span></div>'
            }

            // Tools list
            if( mcp.tools && mcp.tools.length > 0 ) {
                inner += '<h3 style="margin-top:16px">Tools</h3>'
                inner += '<div class="tools-grid">'

                var x402ToolNames = {}

                if( mcp.x402 && mcp.x402.restrictedCalls ) {
                    mcp.x402.restrictedCalls.forEach( function( t ) {
                        x402ToolNames[ t.toolName || t.name || t ] = true
                    } )
                }

                var uiToolNames = {}

                if( ui && ui.uiLinkedTools ) {
                    ui.uiLinkedTools.forEach( function( t ) {
                        uiToolNames[ t.name || t ] = true
                    } )
                }

                mcp.tools.forEach( function( tool ) {
                    var toolName = tool.name || '-'
                    var isX402 = x402ToolNames[ toolName ] || false

                    if( !isX402 ) {
                        var str = JSON.stringify( tool ).toLowerCase()

                        isX402 = str.indexOf( 'x402' ) !== -1 ||
                            str.indexOf( 'paymentrequir' ) !== -1 ||
                            str.indexOf( 'payment_requir' ) !== -1
                    }

                    var isUI = uiToolNames[ toolName ] || false

                    var cls = isX402 ? 'tool-item x402-tool' : 'tool-item'

                    inner += '<div class="' + cls + '">'
                    inner += '<div class="tool-name">' + escapeHtml( toolName )

                    if( isX402 ) { inner += ' <span class="badge badge-green">x402</span>' }
                    if( isUI ) { inner += ' <span class="badge badge-purple">UI</span>' }

                    inner += '</div>'
                    inner += '<div class="tool-desc">' + escapeHtml( ( tool.description || '' ).substring( 0, 120 ) ) + '</div>'
                    inner += '</div>'
                } )

                inner += '</div>'
            }

            return wrapCollapsible( 'MCP Server', inner, true )
        }

        // ── A2A Detail ──

        function renderA2aDetail( a2a, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Agent Name:</span> <span>' + escapeHtml( a2a.agentName || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( a2a.agentDescription || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Version:</span> <span>' + escapeHtml( a2a.agentVersion || '-' ) + '</span></div>'

            if( a2a.provider && ( a2a.provider.organization || a2a.provider.url ) ) {
                var providerText = a2a.provider.organization || '-'

                inner += '<div class="field"><span class="label">Provider:</span> <span>'

                if( a2a.provider.url ) {
                    inner += '<a href="' + escapeHtml( a2a.provider.url ) + '" target="_blank" rel="noopener">' + escapeHtml( providerText ) + '</a>'
                } else {
                    inner += escapeHtml( providerText )
                }

                inner += '</span></div>'
            }

            inner += '<div class="field"><span class="label">Skills:</span> <span>' + ( a2a.skillCount || 0 ) + '</span></div>'

            if( a2a.skills && a2a.skills.length > 0 ) {
                inner += '<div class="field"><span class="label">Skill List:</span> <span>'

                a2a.skills.forEach( function( skill ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( skill.name || skill.id || '-' ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( a2a.protocolVersion ) {
                inner += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( a2a.protocolVersion ) + '</span></div>'
            }

            if( a2a.protocolBindings && a2a.protocolBindings.length > 0 ) {
                inner += '<div class="field"><span class="label">Protocol Bindings:</span> <span>'

                a2a.protocolBindings.forEach( function( binding ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( typeof binding === 'string' ? binding : JSON.stringify( binding ) ) + '</span> '
                } )

                inner += '</span></div>'
            }

            // AP2
            if( a2a.ap2Version || cats.supportsA2aAp2 ) {
                inner += '<div class="field"><span class="label">AP2:</span> <span>'
                inner += '<span class="badge badge-green">Detected</span> '

                if( a2a.ap2Version ) {
                    inner += '<span class="badge badge-blue">v' + escapeHtml( a2a.ap2Version ) + '</span>'
                }

                inner += '</span></div>'
            }

            // AP2 Roles
            if( a2a.ap2Roles && a2a.ap2Roles.length > 0 ) {
                inner += '<div class="field"><span class="label">AP2 Roles:</span> <span>'

                a2a.ap2Roles.forEach( function( role ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( role ) + '</span> '
                } )

                inner += '</span></div>'
            }

            // x402 A2A Extension
            if( a2a.x402Version || cats.supportsA2aX402 ) {
                inner += '<div class="field"><span class="label">x402 (A2A):</span> <span>'
                inner += '<span class="badge badge-green">Detected</span> '

                if( a2a.x402Version ) {
                    inner += '<span class="badge badge-blue">v' + escapeHtml( a2a.x402Version ) + '</span>'
                }

                inner += '</span></div>'
            }

            // Embedded Flow (AP2 + x402)
            if( cats.supportsA2aEmbeddedFlow ) {
                inner += '<div class="field"><span class="label">Embedded Flow:</span> <span>'
                inner += '<span class="badge badge-green">AP2 + x402</span>'
                inner += '</span></div>'
            }

            // ERC-8004 Service Link
            if( a2a.erc8004ServiceUrl || cats.hasA2aErc8004ServiceLink ) {
                inner += '<div class="field"><span class="label">ERC-8004 Service:</span> <span>'

                if( a2a.erc8004ServiceUrl ) {
                    inner += '<a href="' + escapeHtml( a2a.erc8004ServiceUrl ) + '" target="_blank" rel="noopener">' + escapeHtml( a2a.erc8004ServiceUrl ) + '</a>'
                } else {
                    inner += '<span class="badge badge-green">Linked</span>'
                }

                inner += '</span></div>'
            }

            // Extensions
            if( a2a.extensions && typeof a2a.extensions === 'object' && Object.keys( a2a.extensions ).length > 0 ) {
                inner += '<div class="field"><span class="label">Extensions:</span> <span>'

                Object.keys( a2a.extensions ).forEach( function( key ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            // A2A Categories
            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'hasAgentCard': cats.hasA2aCard,
                'hasValidStructure': cats.hasA2aValidStructure,
                'hasSkills': cats.hasA2aSkills,
                'supportsStreaming': cats.supportsA2aStreaming,
                'hasSecuritySchemes': cats.hasA2aSecuritySchemes,
                'hasProvider': cats.hasA2aProvider,
                'supportsPushNotifications': cats.supportsA2aPushNotifications,
                'supportsJsonRpc': cats.supportsA2aJsonRpc,
                'supportsGrpc': cats.supportsA2aGrpc,
                'supportsExtendedCard': cats.supportsA2aExtendedCard,
                'hasDocumentation': cats.hasA2aDocumentation,
                'supportsAp2': cats.supportsA2aAp2,
                'supportsX402': cats.supportsA2aX402,
                'supportsEmbeddedFlow': cats.supportsA2aEmbeddedFlow,
                'hasErc8004ServiceLink': cats.hasA2aErc8004ServiceLink
            } )

            return wrapCollapsible( 'A2A Agent', inner, true )
        }

        // ── x402 Detail ──

        function renderX402Detail( x402, cats ) {
            var inner = '<div class="probe-summary">'

            if( x402.version !== null && x402.version !== undefined ) {
                inner += '<div class="field"><span class="label">x402 Version:</span> <span>v' + x402.version + '</span></div>'
            }

            var networks = x402.networks || []

            if( networks.length > 0 ) {
                inner += '<div class="field"><span class="label">Networks:</span> <span>'

                networks.forEach( function( n ) {
                    inner += '<span class="badge badge-green">' + escapeHtml( CHAIN_NAMES[ n ] || n ) + '</span> '
                } )

                inner += '</span></div>'
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                inner += '<div class="field"><span class="label">Schemes:</span> <span>'

                schemes.forEach( function( s ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( s ) + '</span> '
                } )

                inner += '</span></div>'
            }

            // Payment Options — grouped by unique payment option
            var perTool = x402.perTool || {}
            var perToolKeys = Object.keys( perTool )

            if( perToolKeys.length > 0 ) {
                inner += '</div>'
                inner += '<h3 style="margin-top:16px">Payment Options</h3>'

                var optionGroups = {}

                perToolKeys.forEach( function( toolName ) {
                    var toolData = perTool[ toolName ]
                    var toolNetworks = toolData.networks || []
                    var byNetwork = toolData.byNetwork || {}

                    toolNetworks.forEach( function( network ) {
                        var opt = byNetwork[ network ] || {}
                        var key = network + '|' + ( opt.scheme || '' ) + '|' + ( opt.payTo || '' )

                        if( !optionGroups[ key ] ) {
                            optionGroups[ key ] = { network: network, opt: opt, tools: [] }
                        }

                        optionGroups[ key ].tools.push( toolName )
                    } )
                } )

                Object.keys( optionGroups ).forEach( function( key ) {
                    var group = optionGroups[ key ]
                    var details = []

                    if( group.opt.scheme ) { details.push( 'Scheme: ' + group.opt.scheme ) }
                    if( group.opt.amount ) { details.push( 'Amount: ' + group.opt.amount ) }
                    if( group.opt.payTo ) { details.push( 'Pay to: ' + group.opt.payTo.substring( 0, 10 ) + '...' + group.opt.payTo.slice( -6 ) ) }
                    if( group.opt.maxTimeoutSeconds ) { details.push( 'Timeout: ' + group.opt.maxTimeoutSeconds + 's' ) }

                    inner += '<div class="payment-option-group">'
                    inner += '<div class="payment-option-header">'
                    inner += '<span class="badge badge-green">' + escapeHtml( chainLabel( group.network ) ) + '</span>'
                    inner += '</div>'
                    inner += '<div class="payment-option-details">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                    inner += '<div class="payment-option-tools">'
                    inner += '<span class="label">Tools (' + group.tools.length + '):</span> '

                    inner += group.tools.map( function( t ) {
                        return '<span class="tool-tag">' + escapeHtml( t ) + '</span>'
                    } ).join( ' ' )

                    inner += '</div>'
                    inner += '</div>'
                } )
            } else {
                var paymentOptions = x402.paymentOptions || []

                if( paymentOptions.length > 0 ) {
                    inner += '</div>'
                    inner += '<h3 style="margin-top:16px">Payment Requirements</h3>'
                    inner += '<div class="tools-grid">'

                    paymentOptions.forEach( function( pr ) {
                        inner += '<div class="tool-item x402-tool">'

                        if( pr.network ) { inner += '<div class="tool-name">' + escapeHtml( chainLabel( pr.network ) ) + '</div>' }

                        var details = []

                        if( pr.scheme ) { details.push( 'Scheme: ' + pr.scheme ) }
                        if( pr.maxAmountRequired ) { details.push( 'Max: ' + pr.maxAmountRequired ) }
                        if( pr.resource ) { details.push( 'Resource: ' + pr.resource ) }
                        if( pr.payTo ) { details.push( 'Pay to: ' + pr.payTo.substring( 0, 10 ) + '...' + pr.payTo.slice( -6 ) ) }

                        if( details.length > 0 ) {
                            inner += '<div class="tool-desc">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                        }

                        inner += '</div>'
                    } )

                    inner += '</div>'
                } else {
                    inner += '</div>'
                }
            }

            // x402 Categories
            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsX402': cats.supportsX402,
                'hasValidPaymentRequirements': cats.hasValidPaymentRequirements,
                'supportsExactScheme': cats.supportsExactScheme,
                'supportsEvm': cats.supportsEvm,
                'supportsSolana': cats.supportsSolana
            } )

            return wrapCollapsible( 'x402 Payment Support', inner, true )
        }

        // ── OAuth Detail ──

        function renderOAuthDetail( oauth, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Issuer:</span> <span>' + escapeHtml( oauth.issuer || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Authorization Endpoint:</span> <span>' + escapeHtml( oauth.authorizationEndpoint || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">Token Endpoint:</span> <span>' + escapeHtml( oauth.tokenEndpoint || '-' ) + '</span></div>'

            if( oauth.registrationEndpoint ) {
                inner += '<div class="field"><span class="label">Registration Endpoint:</span> <span>' + escapeHtml( oauth.registrationEndpoint ) + '</span></div>'
            }

            if( oauth.grantTypesSupported && oauth.grantTypesSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">Grant Types:</span> <span>'

                oauth.grantTypesSupported.forEach( function( gt ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( gt ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( oauth.pkceMethodsSupported && oauth.pkceMethodsSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">PKCE Methods:</span> <span>'

                oauth.pkceMethodsSupported.forEach( function( m ) {
                    inner += '<span class="badge badge-green">' + escapeHtml( m ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( oauth.scopesSupported && oauth.scopesSupported.length > 0 ) {
                inner += '<div class="field"><span class="label">Scopes:</span> <span>'

                oauth.scopesSupported.forEach( function( s ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( s ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            // OAuth Categories
            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsOAuth': cats.supportsOAuth,
                'hasProtectedResourceMetadata': cats.hasProtectedResourceMetadata,
                'hasAuthServerMetadata': cats.hasAuthServerMetadata,
                'supportsPkce': cats.supportsPkce,
                'hasDynamicRegistration': cats.hasDynamicRegistration,
                'hasValidOAuthConfig': cats.hasValidOAuthConfig
            } )

            return wrapCollapsible( 'OAuth / Authorization', inner, true )
        }

        // ── MCP Apps Detail ──

        function renderMcpAppsDetail( ui, cats ) {
            var inner = '<div class="probe-summary">'
            inner += '<div class="field"><span class="label">Extension Version:</span> <span>' + escapeHtml( ui.extensionVersion || '-' ) + '</span></div>'
            inner += '<div class="field"><span class="label">UI Resources:</span> <span>' + ( ui.uiResourceCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">Linked Tools:</span> <span>' + ( ui.uiLinkedToolCount || 0 ) + '</span></div>'
            inner += '<div class="field"><span class="label">App-Only Tools:</span> <span>' + ( ui.appOnlyToolCount || 0 ) + '</span></div>'

            if( ui.displayModes && ui.displayModes.length > 0 ) {
                inner += '<div class="field"><span class="label">Display Modes:</span> <span>'

                ui.displayModes.forEach( function( mode ) {
                    inner += '<span class="badge badge-purple">' + escapeHtml( mode ) + '</span> '
                } )

                inner += '</span></div>'
            }

            if( ui.permissionsSummary && ui.permissionsSummary.length > 0 ) {
                inner += '<div class="field"><span class="label">Permissions:</span> <span>'

                ui.permissionsSummary.forEach( function( perm ) {
                    inner += '<span class="badge badge-blue">' + escapeHtml( perm ) + '</span> '
                } )

                inner += '</span></div>'
            }

            inner += '</div>'

            // UI Categories
            inner += '<h3 style="margin-top:16px">Categories</h3>'
            inner += renderCategoryGrid( {
                'supportsMcpApps': cats.uiSupportsMcpApps,
                'hasUiResources': cats.uiHasUiResources,
                'hasToolLinkage': cats.uiHasToolLinkage,
                'hasValidHtml': cats.uiHasValidHtml,
                'hasValidCsp': cats.uiHasValidCsp,
                'supportsTheming': cats.uiSupportsTheming
            } )

            // UI Resources list
            if( ui.uiResources && ui.uiResources.length > 0 ) {
                inner += '<h3 style="margin-top:16px">UI Resources</h3>'
                inner += '<div class="tools-grid">'

                ui.uiResources.forEach( function( res ) {
                    inner += '<div class="tool-item">'
                    inner += '<div class="tool-name">' + escapeHtml( res.uri || res.name || '-' ) + '</div>'

                    var parts = []

                    if( res.mimeType ) { parts.push( res.mimeType ) }
                    if( res.hasCsp ) { parts.push( 'CSP' ) }
                    if( res.displayModes && res.displayModes.length > 0 ) { parts.push( res.displayModes.join( ', ' ) ) }

                    if( parts.length > 0 ) {
                        inner += '<div class="tool-desc">' + escapeHtml( parts.join( ' · ' ) ) + '</div>'
                    }

                    inner += '</div>'
                } )

                inner += '</div>'
            }

            // Linked Tools list
            if( ui.uiLinkedTools && ui.uiLinkedTools.length > 0 ) {
                inner += '<h3 style="margin-top:16px">UI-Linked Tools</h3>'
                inner += '<div class="tools-grid">'

                ui.uiLinkedTools.forEach( function( tool ) {
                    inner += '<div class="tool-item">'
                    inner += '<div class="tool-name">' + escapeHtml( tool.name || '-' )

                    if( tool.visibility ) {
                        inner += ' <span class="badge badge-purple">' + escapeHtml( Array.isArray( tool.visibility ) ? tool.visibility.join( ', ' ) : tool.visibility ) + '</span>'
                    }

                    inner += '</div>'

                    if( tool.resourceUri ) {
                        inner += '<div class="tool-desc">' + escapeHtml( tool.resourceUri ) + '</div>'
                    }

                    inner += '</div>'
                } )

                inner += '</div>'
            }

            return wrapCollapsible( 'MCP Apps', inner, true )
        }

        // ── Validation Messages ──

        function renderMessages( messages ) {
            var inner = ''

            var errors = messages.filter( function( m ) { return m.severity === 'ERROR' } )
            var warnings = messages.filter( function( m ) { return m.severity === 'WARNING' } )
            var infos = messages.filter( function( m ) { return m.severity === 'INFO' } )

            if( errors.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#f04">Errors (' + errors.length + ')</h4>'
                inner += '<ul class="messages-list">'

                errors.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            if( warnings.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#fa0">Warnings (' + warnings.length + ')</h4>'
                inner += '<ul class="messages-list">'

                warnings.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            if( infos.length > 0 ) {
                inner += '<h4 style="margin-top:12px;color:#888">Info (' + infos.length + ')</h4>'
                inner += '<ul class="messages-list">'

                infos.forEach( function( m ) { inner += '<li>' + escapeHtml( m.message ) + '</li>' } )

                inner += '</ul>'
            }

            return wrapCollapsible( 'Validation Messages', inner, false )
        }

        // ── Smart Input Detection ──

        function detectInputType( value ) {
            var trimmed = value.trim()

            if( !trimmed ) { return 'empty' }

            if( trimmed.indexOf( '#' ) === 0 ) { return 'agent' }

            if( /^\d+$/.test( trimmed ) ) { return 'agent' }

            return 'url'
        }

        function getAgentId( value ) {
            var trimmed = value.trim()

            if( trimmed.indexOf( '#' ) === 0 ) { return trimmed.substring( 1 ) }

            return trimmed
        }

        function updateInputMode() {
            var input = document.getElementById( 'urlInput' )
            var btn = document.getElementById( 'validateBtn' )
            var chainSelector = document.getElementById( 'chainSelector' )
            var hint = document.getElementById( 'inputHint' )
            var type = detectInputType( input.value )

            if( type === 'agent' ) {
                btn.textContent = 'Lookup'
                chainSelector.style.display = 'flex'
                hint.textContent = 'Agent ID detected \u2014 will query ERC-8004 on-chain registry'
            } else {
                btn.textContent = 'Validate'
                chainSelector.style.display = 'none'
                hint.textContent = 'Accepts endpoint URLs or ERC-8004 agent IDs (numeric)'
            }
        }

        // Restore last chain selection
        var savedChain = localStorage.getItem( 'mcpValidator_chainId' )

        if( savedChain ) {
            var chainSelect = document.getElementById( 'chainSelect' )
            var options = chainSelect.options

            var i = 0

            var found = false

            // Using Array.from to iterate without for loop
            Array.from( options ).forEach( function( opt ) {
                if( opt.value === savedChain ) {
                    chainSelect.value = savedChain
                    found = true
                }
            } )
        }

        document.getElementById( 'chainSelect' ).addEventListener( 'change', function() {
            localStorage.setItem( 'mcpValidator_chainId', this.value )
        } )

        // ── Validate Action ──

        async function handleSubmit() {
            var input = document.getElementById( 'urlInput' )
            var rawValue = input.value.trim()

            if( !rawValue ) {
                showError( 'Please enter a URL or agent ID.' )

                return
            }

            var type = detectInputType( rawValue )

            if( type === 'agent' ) {
                await lookup()
            } else {
                await validate()
            }
        }

        async function validate() {
            var urlInput = document.getElementById( 'urlInput' )
            var rawUrl = urlInput.value.trim()

            if( rawUrl.indexOf( '://' ) === -1 ) {
                rawUrl = 'https://' + rawUrl
            }

            try {
                new URL( rawUrl )
            } catch( _e ) {
                showError( 'Invalid URL. Please enter a valid URL (e.g. https://example.com).' )

                return
            }

            setValidatorState( 'loading' )
            setLoadingText( 'Probing MCP, A2A, x402, OAuth, MCP Apps (server-side)...' )

            try {
                var response = await fetch( '/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { url: rawUrl } )
                } )

                var data = await response.json()

                if( data.error ) {
                    setValidatorState( 'idle' )
                    showError( data.error )

                    return
                }

                renderVerdicts( data )
                renderDetails( data )
                renderRawAssessment( data, rawUrl )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        function adaptLookupResponse( lookupData ) {
            var r = lookupData.result || {}
            var entries = r.entries || {}
            var rep = r.reputation || {}

            return {
                status: lookupData.status,
                categories: {
                    isHttpReachable: null,
                    supportsMcp: false,
                    hasA2aCard: false,
                    supportsX402: false,
                    supportsOAuth: false,
                    uiSupportsMcpApps: false,
                    hasWellKnownRegistration: false,
                    hasErc8004Registration: r.isOnChainVerified || false,
                    isErc8004OnChainVerified: r.isOnChainVerified || false,
                    isErc8004SpecCompliant: r.isSpecCompliant || false,
                    hasOnChainReputation: rep.feedbackCount !== null && rep.feedbackCount !== undefined
                },
                entries: {
                    http: null,
                    mcp: null,
                    a2a: null,
                    ui: null,
                    erc8004: {
                        agentId: r.agentId,
                        agentRegistry: '0x8004a169fb4a3325136eb29fa0ceb6d2e539a432',
                        chainAlias: r.chainAlias,
                        chainId: r.chainId,
                        registrationName: entries.name || null,
                        registrationDescription: entries.description || null,
                        isOnChainVerified: r.isOnChainVerified || false,
                        isSpecCompliant: r.isSpecCompliant || false,
                        x402Support: r.x402Support,
                        isActive: r.isActive,
                        services: r.services
                    },
                    reputation: rep,
                    assessment: null
                },
                messages: ( lookupData.messages || [] ).map( function( msg ) {
                    var severity = 'INFO'

                    if( msg.indexOf( 'LKP-0' ) === 0 ) { severity = 'WARNING' }
                    if( msg.indexOf( 'LKP-01' ) === 0 || msg.indexOf( 'LKP-02' ) === 0 ) { severity = 'ERROR' }

                    return { severity: severity, message: msg }
                } )
            }
        }

        async function lookup() {
            var input = document.getElementById( 'urlInput' )
            var agentId = getAgentId( input.value )
            var chainId = Number( document.getElementById( 'chainSelect' ).value )

            setValidatorState( 'loading' )
            setLoadingText( 'Looking up agent #' + agentId + ' on-chain...' )

            try {
                var response = await fetch( '/api/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { agentId: Number( agentId ), chainId: chainId } )
                } )

                var raw = await response.json()

                if( raw.error ) {
                    setValidatorState( 'idle' )
                    showError( raw.error )

                    return
                }

                var data = adaptLookupResponse( raw )

                renderVerdicts( data )
                renderDetails( data )
                renderRawAssessment( raw, 'agent:#' + agentId + '@' + chainId )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        document.getElementById( 'validateBtn' ).addEventListener( 'click', handleSubmit )

        document.getElementById( 'urlInput' ).addEventListener( 'keydown', function( e ) {
            if( e.key === 'Enter' ) { handleSubmit() }
        } )

        document.getElementById( 'urlInput' ).addEventListener( 'input', updateInputMode )

        document.querySelectorAll( '.example-urls a' ).forEach( function( link ) {
            link.addEventListener( 'click', function( e ) {
                e.preventDefault()
                var input = document.getElementById( 'urlInput' )
                var dataUrl = link.getAttribute( 'data-url' )

                input.value = dataUrl
                updateInputMode()
                handleSubmit()
            } )
        } )

        // ── Dependency Footer ──

        function loadDependencyInfo() {
            fetch( '/api/info' )
                .then( function( res ) { return res.json() } )
                .then( function( info ) {
                    var container = document.getElementById( 'depInfo' )

                    if( !info.dependencies || info.dependencies.length === 0 ) {
                        return
                    }

                    var links = info.dependencies
                        .map( function( dep ) {
                            if( !dep.shortHash || !dep.commitUrl ) {
                                return '<span class="dep-link">' + escapeHtml( dep.name ) + '</span>'
                            }

                            return '<a class="dep-link" href="' + escapeHtml( dep.commitUrl ) + '" target="_blank" rel="noopener">' +
                                escapeHtml( dep.name ) + ' <span class="dep-hash">' + escapeHtml( dep.shortHash ) + '</span></a>'
                        } )
                        .join( ' &middot; ' )

                    container.innerHTML = '<span class="dep-info-label">Validation modules</span>' + links
                } )
                .catch( function() {} )
        }

        loadDependencyInfo()

        // ── Raw Assessment Viewer ──

        function renderRawAssessment( data, url ) {
            var container = document.getElementById( 'rawAssessmentSection' )
            var jsonStr = JSON.stringify( data, null, 2 )

            var hostname = ''

            try {
                hostname = new URL( url ).hostname
            } catch( _e ) {
                hostname = url.replace( /[^a-zA-Z0-9\-_#]/g, '_' ) || 'unknown'
            }

            var timestamp = new Date().toISOString().replace( /[:.]/g, '-' ).slice( 0, 19 )
            var filename = 'assessment-' + hostname + '-' + timestamp + '.json'

            var html = '<div class="detail-section">' +
                '<div class="section-toggle" onclick="toggleSection(this)">' +
                '<span class="section-arrow">\u25B6</span>' +
                '<h3>Raw Assessment</h3>' +
                '</div>' +
                '<div class="section-content" style="display:none">' +
                '<div class="raw-actions">' +
                '<button class="raw-btn" id="rawCopyBtn">Copy</button>' +
                '<button class="raw-btn" id="rawDownloadBtn">Download</button>' +
                '</div>' +
                '<pre><code>' + escapeHtml( jsonStr ) + '</code></pre>' +
                '</div>' +
                '</div>'

            container.innerHTML = html

            document.getElementById( 'rawCopyBtn' ).addEventListener( 'click', function() {
                var btn = this

                navigator.clipboard.writeText( jsonStr ).then( function() {
                    btn.textContent = 'Copied!'
                    setTimeout( function() { btn.textContent = 'Copy' }, 2000 )
                } )
            } )

            document.getElementById( 'rawDownloadBtn' ).addEventListener( 'click', function() {
                var blob = new Blob( [ jsonStr ], { type: 'application/json' } )
                var a = document.createElement( 'a' )

                a.href = URL.createObjectURL( blob )
                a.download = filename
                document.body.appendChild( a )
                a.click()
                document.body.removeChild( a )
                URL.revokeObjectURL( a.href )
            } )
        }

    </script>
</body>
</html>
