<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Agent Validator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>MCP Agent Validator</h1>
            <p class="subtitle">Validate MCP, A2A, x402, OAuth, and MCP Apps endpoints</p>
        </header>

        <div>
            <div class="validator-input">
                <input type="text" id="urlInput" placeholder="https://your-endpoint.example.com" spellcheck="false">
                <button class="validator-btn" id="validateBtn">Validate</button>
            </div>

            <div class="example-urls">
                <span>Try:</span>
                <a data-url="https://x402.flowmcp.org/mcp/streamable">x402.flowmcp.org/mcp/streamable</a>
                <a data-url="https://blackjack.nanobot.ai/mcp">blackjack.nanobot.ai/mcp</a>
            </div>

            <div class="error-message" id="errorBox"></div>

            <div class="loading-section" id="loadingSection">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">Probing endpoint...</div>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="verdict-grid" id="verdictGrid"></div>
                <div id="detailSections"></div>
            </div>

            <div id="rawAssessmentSection" class="raw-assessment-section" style="display:none"></div>
        </div>

        <footer>
            <a href="https://github.com/FlowMCP/mcp-agent-validator">mcp-agent-validator</a> &middot;
            Server-side validation via Node.js probes
            <div id="depInfo" class="dep-info"></div>
        </footer>
    </div>

    <script>
        // ── Chain Name Mapping ──

        var CHAIN_NAMES = {
            'eip155:1': 'Ethereum',
            'eip155:10': 'Optimism',
            'eip155:137': 'Polygon',
            'eip155:42161': 'Arbitrum',
            'eip155:8453': 'Base',
            'eip155:43113': 'Avalanche Fuji',
            'eip155:11155111': 'Ethereum Sepolia',
            'eip155:84532': 'Base Sepolia',
            'eip155:421614': 'Arbitrum Sepolia',
            'eip155:11155420': 'Optimism Sepolia',
            'solana:mainnet': 'Solana',
            'solana:devnet': 'Solana Devnet'
        }

        function chainLabel( caip2 ) {
            var name = CHAIN_NAMES[ caip2 ]

            return name ? caip2 + ' (' + name + ')' : caip2
        }

        // ── Helpers ──

        function escapeHtml( str ) {
            var div = document.createElement( 'div' )
            div.textContent = str

            return div.innerHTML
        }

        function show( el ) { el.style.display = 'block' }
        function hide( el ) { el.style.display = 'none' }

        function renderCategoryGrid( obj ) {
            var html = '<div class="categories-grid">'

            Object.keys( obj ).forEach( function( key ) {
                var val = obj[ key ]

                if( val === null || val === undefined ) { return }

                var icon = val
                    ? '<span class="check-yes">&#10003;</span>'
                    : '<span class="check-no">&#10005;</span>'

                html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
            } )

            html += '</div>'

            return html
        }

        // ── State Management ──

        function setValidatorState( state ) {
            var loading = document.getElementById( 'loadingSection' )
            var results = document.getElementById( 'resultsSection' )
            var rawSection = document.getElementById( 'rawAssessmentSection' )
            var errorBox = document.getElementById( 'errorBox' )
            var btn = document.getElementById( 'validateBtn' )

            hide( loading )
            hide( results )
            hide( rawSection )
            hide( errorBox )
            btn.disabled = false

            if( state === 'loading' ) {
                show( loading )
                btn.disabled = true
            } else if( state === 'results' ) {
                show( results )
                show( rawSection )
            }
        }

        function showError( msg ) {
            var errorBox = document.getElementById( 'errorBox' )
            errorBox.textContent = msg
            show( errorBox )
        }

        function setLoadingText( text ) {
            document.getElementById( 'loadingText' ).textContent = text
        }

        // ── x402 Detail Helper ──

        function buildX402Detail( x402 ) {
            if( !x402 ) { return 'Supported' }

            var restrictedCalls = x402.restrictedCalls || []

            if( restrictedCalls.length > 0 ) {
                return restrictedCalls.length + ' payment tool' + ( restrictedCalls.length !== 1 ? 's' : '' )
            }

            var parts = []
            var networks = x402.networks || []

            if( networks.length > 0 ) {
                parts.push( networks.length + ' network' + ( networks.length !== 1 ? 's' : '' ) )
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                parts.push( schemes.join( ', ' ) )
            }

            return parts.length > 0 ? parts.join( ' · ' ) : 'Supported'
        }

        // ── Verdict Cards ──

        function renderVerdicts( data ) {
            var grid = document.getElementById( 'verdictGrid' )
            var cats = data.categories
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var x402 = mcp ? mcp.x402 : null
            var oauth = mcp ? mcp.oauth : null
            var assessment = data.entries.assessment

            var cards = [
                {
                    label: 'MCP',
                    pass: cats.supportsMcp,
                    detail: cats.supportsMcp
                        ? ( mcp.serverName || 'MCP Server' ) + ' (' + ( mcp.toolCount || 0 ) + ' tools)'
                        : 'Not detected'
                },
                {
                    label: 'A2A / AP2',
                    pass: cats.hasA2aCard,
                    detail: cats.hasA2aCard
                        ? ( a2a ? ( a2a.agentName || 'A2A Agent' ) : 'A2A Agent' )
                        : 'Not detected'
                },
                {
                    label: 'x402',
                    pass: cats.supportsX402,
                    detail: cats.supportsX402
                        ? buildX402Detail( x402 )
                        : 'Not detected'
                },
                {
                    label: 'OAuth',
                    pass: cats.supportsOAuth,
                    detail: cats.supportsOAuth
                        ? ( oauth ? ( oauth.issuer || 'OAuth detected' ) : 'OAuth detected' )
                        : 'Not required'
                },
                {
                    label: 'MCP Apps',
                    pass: cats.uiSupportsMcpApps,
                    detail: cats.uiSupportsMcpApps
                        ? ( ui ? ( ui.uiResourceCount + ' UI resource' + ( ui.uiResourceCount !== 1 ? 's' : '' ) ) : 'Detected' )
                        : 'Not detected'
                }
            ]

            grid.innerHTML = cards.map( function( card ) {
                var cls = card.pass ? 'pass' : 'fail'
                var icon = card.pass
                    ? '<span class="check-yes" style="font-size:28px">&#10003;</span>'
                    : '<span class="check-no" style="font-size:28px">&#10005;</span>'

                return '<div class="verdict-card ' + cls + '">' +
                    '<div class="verdict-icon">' + icon + '</div>' +
                    '<div class="verdict-label">' + escapeHtml( card.label ) + '</div>' +
                    '<div class="verdict-detail">' + escapeHtml( card.detail ) + '</div>' +
                    '</div>'
            } ).join( '' )
        }

        // ── Detail Sections ──

        function renderDetails( data ) {
            var container = document.getElementById( 'detailSections' )
            var cats = data.categories
            var mcp = data.entries.mcp
            var a2a = data.entries.a2a
            var ui = data.entries.ui
            var html = ''

            if( cats.supportsMcp && mcp ) {
                html += renderMcpDetail( mcp, cats, ui )
            }

            if( cats.hasA2aCard && a2a ) {
                html += renderA2aDetail( a2a, cats )
            }

            if( cats.supportsX402 && mcp && mcp.x402 ) {
                html += renderX402Detail( mcp.x402, cats )
            }

            if( cats.supportsOAuth && mcp && mcp.oauth ) {
                html += renderOAuthDetail( mcp.oauth, cats )
            }

            if( cats.uiSupportsMcpApps && ui ) {
                html += renderMcpAppsDetail( ui, cats )
            }

            if( data.messages && data.messages.length > 0 ) {
                html += renderMessages( data.messages )
            }

            container.innerHTML = html
        }

        // ── MCP Detail ──

        function renderMcpDetail( mcp, cats, ui ) {
            var html = '<div class="detail-section"><h3>MCP Server</h3>'
            html += '<div class="probe-summary">'
            html += '<div class="field"><span class="label">Server Name:</span> <span>' + escapeHtml( mcp.serverName || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">Server Version:</span> <span>' + escapeHtml( mcp.serverVersion || '-' ) + '</span></div>'

            if( mcp.serverDescription ) {
                html += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( mcp.serverDescription ) + '</span></div>'
            }

            if( mcp.protocolVersion ) {
                html += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( mcp.protocolVersion ) + '</span></div>'
            }

            html += '<div class="field"><span class="label">Tools:</span> <span>' + ( mcp.toolCount || 0 ) + '</span></div>'
            html += '<div class="field"><span class="label">Resources:</span> <span>' + ( mcp.resourceCount || 0 ) + '</span></div>'
            html += '<div class="field"><span class="label">Prompts:</span> <span>' + ( mcp.promptCount || 0 ) + '</span></div>'

            if( mcp.instructions ) {
                html += '<div class="field"><span class="label">Instructions:</span> <span>' + escapeHtml( mcp.instructions.substring( 0, 200 ) ) + ( mcp.instructions.length > 200 ? '...' : '' ) + '</span></div>'
            }

            var latency = mcp.latency || {}

            if( latency.ping !== null && latency.ping !== undefined ) {
                var pingPct = Math.min( latency.ping / 5000 * 100, 100 )

                html += '<div class="latency-bar">'
                html += '<span class="latency-label">Ping Latency:</span>'
                html += '<div class="latency-track"><div class="latency-fill" style="width:' + pingPct + '%"></div></div>'
                html += '<span class="latency-value">' + latency.ping + ' ms</span>'
                html += '</div>'
            }

            if( latency.listTools !== null && latency.listTools !== undefined ) {
                var toolsPct = Math.min( latency.listTools / 5000 * 100, 100 )

                html += '<div class="latency-bar">'
                html += '<span class="latency-label">Tools Latency:</span>'
                html += '<div class="latency-track"><div class="latency-fill" style="width:' + toolsPct + '%"></div></div>'
                html += '<span class="latency-value">' + latency.listTools + ' ms</span>'
                html += '</div>'
            }

            html += '</div>'

            // Core categories
            html += '<h3 style="margin-top:16px">Core</h3>'
            html += renderCategoryGrid( {
                'isReachable': cats.isReachable,
                'supportsMcp': cats.supportsMcp,
                'hasTools': cats.hasTools,
                'hasResources': cats.hasResources,
                'hasPrompts': cats.hasPrompts
            } )

            // Extended capabilities
            html += '<h3 style="margin-top:16px">Capabilities</h3>'
            html += renderCategoryGrid( {
                'supportsTasks': cats.supportsTasks,
                'supportsMcpApps': cats.supportsMcpApps,
                'supportsLogging': cats.supportsLogging,
                'supportsCompletions': cats.supportsCompletions,
                'supportsResourceSubscription': cats.supportsResourceSubscription,
                'supportsResourceListChanged': cats.supportsResourceListChanged,
                'supportsPromptListChanged': cats.supportsPromptListChanged,
                'supportsToolListChanged': cats.supportsToolListChanged,
                'supportsTaskList': cats.supportsTaskList,
                'supportsTaskCancel': cats.supportsTaskCancel,
                'supportsTaskAugmentedToolCall': cats.supportsTaskAugmentedToolCall,
                'hasExperimentalCapabilities': cats.hasExperimentalCapabilities,
                'supportsSampling': cats.supportsSampling,
                'supportsElicitation': cats.supportsElicitation
            } )

            if( mcp.experimentalCapabilities && mcp.experimentalCapabilities.length > 0 ) {
                html += '<div class="field" style="margin-top:8px"><span class="label">Experimental:</span> <span>'

                mcp.experimentalCapabilities.forEach( function( key ) {
                    html += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                html += '</span></div>'
            }

            if( mcp.taskCapabilities ) {
                html += '<div class="field" style="margin-top:8px"><span class="label">Task Features:</span> <span>'

                if( mcp.taskCapabilities.list ) { html += '<span class="badge badge-blue">list</span> ' }
                if( mcp.taskCapabilities.cancel ) { html += '<span class="badge badge-blue">cancel</span> ' }
                if( mcp.taskCapabilities.augmentedToolCall ) { html += '<span class="badge badge-blue">augmentedToolCall</span> ' }

                html += '</span></div>'
            }

            // Tools list
            if( mcp.tools && mcp.tools.length > 0 ) {
                html += '<h3 style="margin-top:16px">Tools</h3>'
                html += '<div class="tools-grid">'

                var x402ToolNames = {}

                if( mcp.x402 && mcp.x402.restrictedCalls ) {
                    mcp.x402.restrictedCalls.forEach( function( t ) {
                        x402ToolNames[ t.toolName || t.name || t ] = true
                    } )
                }

                var uiToolNames = {}

                if( ui && ui.uiLinkedTools ) {
                    ui.uiLinkedTools.forEach( function( t ) {
                        uiToolNames[ t.name || t ] = true
                    } )
                }

                mcp.tools.forEach( function( tool ) {
                    var toolName = tool.name || '-'
                    var isX402 = x402ToolNames[ toolName ] || false

                    if( !isX402 ) {
                        var str = JSON.stringify( tool ).toLowerCase()

                        isX402 = str.indexOf( 'x402' ) !== -1 ||
                            str.indexOf( 'paymentrequir' ) !== -1 ||
                            str.indexOf( 'payment_requir' ) !== -1
                    }

                    var isUI = uiToolNames[ toolName ] || false

                    var cls = isX402 ? 'tool-item x402-tool' : 'tool-item'

                    html += '<div class="' + cls + '">'
                    html += '<div class="tool-name">' + escapeHtml( toolName )

                    if( isX402 ) { html += ' <span class="badge badge-green">x402</span>' }
                    if( isUI ) { html += ' <span class="badge badge-purple">UI</span>' }

                    html += '</div>'
                    html += '<div class="tool-desc">' + escapeHtml( ( tool.description || '' ).substring( 0, 120 ) ) + '</div>'
                    html += '</div>'
                } )

                html += '</div>'
            }

            html += '</div>'

            return html
        }

        // ── A2A Detail ──

        function renderA2aDetail( a2a, cats ) {
            var html = '<div class="detail-section"><h3>A2A Agent</h3>'
            html += '<div class="probe-summary">'
            html += '<div class="field"><span class="label">Agent Name:</span> <span>' + escapeHtml( a2a.agentName || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( a2a.agentDescription || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">Version:</span> <span>' + escapeHtml( a2a.agentVersion || '-' ) + '</span></div>'

            if( a2a.provider && ( a2a.provider.organization || a2a.provider.url ) ) {
                var providerText = a2a.provider.organization || '-'

                html += '<div class="field"><span class="label">Provider:</span> <span>'

                if( a2a.provider.url ) {
                    html += '<a href="' + escapeHtml( a2a.provider.url ) + '" target="_blank" rel="noopener">' + escapeHtml( providerText ) + '</a>'
                } else {
                    html += escapeHtml( providerText )
                }

                html += '</span></div>'
            }

            html += '<div class="field"><span class="label">Skills:</span> <span>' + ( a2a.skillCount || 0 ) + '</span></div>'

            if( a2a.skills && a2a.skills.length > 0 ) {
                html += '<div class="field"><span class="label">Skill List:</span> <span>'

                a2a.skills.forEach( function( skill ) {
                    html += '<span class="badge badge-blue">' + escapeHtml( skill.name || skill.id || '-' ) + '</span> '
                } )

                html += '</span></div>'
            }

            if( a2a.protocolVersion ) {
                html += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( a2a.protocolVersion ) + '</span></div>'
            }

            if( a2a.protocolBindings && a2a.protocolBindings.length > 0 ) {
                html += '<div class="field"><span class="label">Protocol Bindings:</span> <span>'

                a2a.protocolBindings.forEach( function( binding ) {
                    html += '<span class="badge badge-blue">' + escapeHtml( typeof binding === 'string' ? binding : JSON.stringify( binding ) ) + '</span> '
                } )

                html += '</span></div>'
            }

            // AP2
            if( a2a.ap2Version || cats.supportsA2aAp2 ) {
                html += '<div class="field"><span class="label">AP2:</span> <span>'
                html += '<span class="badge badge-green">Detected</span> '

                if( a2a.ap2Version ) {
                    html += '<span class="badge badge-blue">v' + escapeHtml( a2a.ap2Version ) + '</span>'
                }

                html += '</span></div>'
            }

            // ERC-8004 Service Link
            if( a2a.erc8004ServiceUrl || cats.hasA2aErc8004ServiceLink ) {
                html += '<div class="field"><span class="label">ERC-8004 Service:</span> <span>'

                if( a2a.erc8004ServiceUrl ) {
                    html += '<a href="' + escapeHtml( a2a.erc8004ServiceUrl ) + '" target="_blank" rel="noopener">' + escapeHtml( a2a.erc8004ServiceUrl ) + '</a>'
                } else {
                    html += '<span class="badge badge-green">Linked</span>'
                }

                html += '</span></div>'
            }

            // Extensions
            if( a2a.extensions && typeof a2a.extensions === 'object' && Object.keys( a2a.extensions ).length > 0 ) {
                html += '<div class="field"><span class="label">Extensions:</span> <span>'

                Object.keys( a2a.extensions ).forEach( function( key ) {
                    html += '<span class="badge badge-purple">' + escapeHtml( key ) + '</span> '
                } )

                html += '</span></div>'
            }

            html += '</div>'

            // A2A Categories
            html += '<h3 style="margin-top:16px">Categories</h3>'
            html += renderCategoryGrid( {
                'hasAgentCard': cats.hasA2aCard,
                'hasValidStructure': cats.hasA2aValidStructure,
                'hasSkills': cats.hasA2aSkills,
                'supportsStreaming': cats.supportsA2aStreaming,
                'hasSecuritySchemes': cats.hasA2aSecuritySchemes,
                'hasProvider': cats.hasA2aProvider,
                'supportsPushNotifications': cats.supportsA2aPushNotifications,
                'supportsJsonRpc': cats.supportsA2aJsonRpc,
                'supportsGrpc': cats.supportsA2aGrpc,
                'supportsExtendedCard': cats.supportsA2aExtendedCard,
                'hasDocumentation': cats.hasA2aDocumentation,
                'supportsAp2': cats.supportsA2aAp2,
                'hasErc8004ServiceLink': cats.hasA2aErc8004ServiceLink
            } )

            html += '</div>'

            return html
        }

        // ── x402 Detail ──

        function renderX402Detail( x402, cats ) {
            var html = '<div class="detail-section"><h3>x402 Payment Support</h3>'
            html += '<div class="probe-summary">'

            if( x402.version !== null && x402.version !== undefined ) {
                html += '<div class="field"><span class="label">x402 Version:</span> <span>v' + x402.version + '</span></div>'
            }

            var networks = x402.networks || []

            if( networks.length > 0 ) {
                html += '<div class="field"><span class="label">Networks:</span> <span>'

                networks.forEach( function( n ) {
                    html += '<span class="badge badge-green">' + escapeHtml( CHAIN_NAMES[ n ] || n ) + '</span> '
                } )

                html += '</span></div>'
            }

            var schemes = x402.schemes || []

            if( schemes.length > 0 ) {
                html += '<div class="field"><span class="label">Schemes:</span> <span>'

                schemes.forEach( function( s ) {
                    html += '<span class="badge badge-blue">' + escapeHtml( s ) + '</span> '
                } )

                html += '</span></div>'
            }

            // Payment Options — grouped by unique payment option
            var perTool = x402.perTool || {}
            var perToolKeys = Object.keys( perTool )

            if( perToolKeys.length > 0 ) {
                html += '</div>'
                html += '<h3 style="margin-top:16px">Payment Options</h3>'

                var optionGroups = {}

                perToolKeys.forEach( function( toolName ) {
                    var toolData = perTool[ toolName ]
                    var toolNetworks = toolData.networks || []
                    var byNetwork = toolData.byNetwork || {}

                    toolNetworks.forEach( function( network ) {
                        var opt = byNetwork[ network ] || {}
                        var key = network + '|' + ( opt.scheme || '' ) + '|' + ( opt.payTo || '' )

                        if( !optionGroups[ key ] ) {
                            optionGroups[ key ] = { network: network, opt: opt, tools: [] }
                        }

                        optionGroups[ key ].tools.push( toolName )
                    } )
                } )

                Object.keys( optionGroups ).forEach( function( key ) {
                    var group = optionGroups[ key ]
                    var details = []

                    if( group.opt.scheme ) { details.push( 'Scheme: ' + group.opt.scheme ) }
                    if( group.opt.amount ) { details.push( 'Amount: ' + group.opt.amount ) }
                    if( group.opt.payTo ) { details.push( 'Pay to: ' + group.opt.payTo.substring( 0, 10 ) + '...' + group.opt.payTo.slice( -6 ) ) }
                    if( group.opt.maxTimeoutSeconds ) { details.push( 'Timeout: ' + group.opt.maxTimeoutSeconds + 's' ) }

                    html += '<div class="payment-option-group">'
                    html += '<div class="payment-option-header">'
                    html += '<span class="badge badge-green">' + escapeHtml( chainLabel( group.network ) ) + '</span>'
                    html += '</div>'
                    html += '<div class="payment-option-details">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                    html += '<div class="payment-option-tools">'
                    html += '<span class="label">Tools (' + group.tools.length + '):</span> '

                    html += group.tools.map( function( t ) {
                        return '<span class="tool-tag">' + escapeHtml( t ) + '</span>'
                    } ).join( ' ' )

                    html += '</div>'
                    html += '</div>'
                } )
            } else {
                var paymentOptions = x402.paymentOptions || []

                if( paymentOptions.length > 0 ) {
                    html += '</div>'
                    html += '<h3 style="margin-top:16px">Payment Requirements</h3>'
                    html += '<div class="tools-grid">'

                    paymentOptions.forEach( function( pr ) {
                        html += '<div class="tool-item x402-tool">'

                        if( pr.network ) { html += '<div class="tool-name">' + escapeHtml( chainLabel( pr.network ) ) + '</div>' }

                        var details = []

                        if( pr.scheme ) { details.push( 'Scheme: ' + pr.scheme ) }
                        if( pr.maxAmountRequired ) { details.push( 'Max: ' + pr.maxAmountRequired ) }
                        if( pr.resource ) { details.push( 'Resource: ' + pr.resource ) }
                        if( pr.payTo ) { details.push( 'Pay to: ' + pr.payTo.substring( 0, 10 ) + '...' + pr.payTo.slice( -6 ) ) }

                        if( details.length > 0 ) {
                            html += '<div class="tool-desc">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                        }

                        html += '</div>'
                    } )

                    html += '</div>'
                } else {
                    html += '</div>'
                }
            }

            // x402 Categories
            html += '<h3 style="margin-top:16px">Categories</h3>'
            html += renderCategoryGrid( {
                'supportsX402': cats.supportsX402,
                'hasValidPaymentRequirements': cats.hasValidPaymentRequirements,
                'supportsExactScheme': cats.supportsExactScheme,
                'supportsEvm': cats.supportsEvm,
                'supportsSolana': cats.supportsSolana
            } )

            html += '</div>'

            return html
        }

        // ── OAuth Detail ──

        function renderOAuthDetail( oauth, cats ) {
            var html = '<div class="detail-section"><h3>OAuth / Authorization</h3>'
            html += '<div class="probe-summary">'
            html += '<div class="field"><span class="label">Issuer:</span> <span>' + escapeHtml( oauth.issuer || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">Authorization Endpoint:</span> <span>' + escapeHtml( oauth.authorizationEndpoint || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">Token Endpoint:</span> <span>' + escapeHtml( oauth.tokenEndpoint || '-' ) + '</span></div>'

            if( oauth.registrationEndpoint ) {
                html += '<div class="field"><span class="label">Registration Endpoint:</span> <span>' + escapeHtml( oauth.registrationEndpoint ) + '</span></div>'
            }

            if( oauth.grantTypesSupported && oauth.grantTypesSupported.length > 0 ) {
                html += '<div class="field"><span class="label">Grant Types:</span> <span>'

                oauth.grantTypesSupported.forEach( function( gt ) {
                    html += '<span class="badge badge-blue">' + escapeHtml( gt ) + '</span> '
                } )

                html += '</span></div>'
            }

            if( oauth.pkceMethodsSupported && oauth.pkceMethodsSupported.length > 0 ) {
                html += '<div class="field"><span class="label">PKCE Methods:</span> <span>'

                oauth.pkceMethodsSupported.forEach( function( m ) {
                    html += '<span class="badge badge-green">' + escapeHtml( m ) + '</span> '
                } )

                html += '</span></div>'
            }

            if( oauth.scopesSupported && oauth.scopesSupported.length > 0 ) {
                html += '<div class="field"><span class="label">Scopes:</span> <span>'

                oauth.scopesSupported.forEach( function( s ) {
                    html += '<span class="badge badge-purple">' + escapeHtml( s ) + '</span> '
                } )

                html += '</span></div>'
            }

            html += '</div>'

            // OAuth Categories
            html += '<h3 style="margin-top:16px">Categories</h3>'
            html += renderCategoryGrid( {
                'supportsOAuth': cats.supportsOAuth,
                'hasProtectedResourceMetadata': cats.hasProtectedResourceMetadata,
                'hasAuthServerMetadata': cats.hasAuthServerMetadata,
                'supportsPkce': cats.supportsPkce,
                'hasDynamicRegistration': cats.hasDynamicRegistration,
                'hasValidOAuthConfig': cats.hasValidOAuthConfig
            } )

            html += '</div>'

            return html
        }

        // ── MCP Apps Detail ──

        function renderMcpAppsDetail( ui, cats ) {
            var html = '<div class="detail-section"><h3>MCP Apps</h3>'
            html += '<div class="probe-summary">'
            html += '<div class="field"><span class="label">Extension Version:</span> <span>' + escapeHtml( ui.extensionVersion || '-' ) + '</span></div>'
            html += '<div class="field"><span class="label">UI Resources:</span> <span>' + ( ui.uiResourceCount || 0 ) + '</span></div>'
            html += '<div class="field"><span class="label">Linked Tools:</span> <span>' + ( ui.uiLinkedToolCount || 0 ) + '</span></div>'
            html += '<div class="field"><span class="label">App-Only Tools:</span> <span>' + ( ui.appOnlyToolCount || 0 ) + '</span></div>'

            if( ui.displayModes && ui.displayModes.length > 0 ) {
                html += '<div class="field"><span class="label">Display Modes:</span> <span>'

                ui.displayModes.forEach( function( mode ) {
                    html += '<span class="badge badge-purple">' + escapeHtml( mode ) + '</span> '
                } )

                html += '</span></div>'
            }

            if( ui.permissionsSummary && ui.permissionsSummary.length > 0 ) {
                html += '<div class="field"><span class="label">Permissions:</span> <span>'

                ui.permissionsSummary.forEach( function( perm ) {
                    html += '<span class="badge badge-blue">' + escapeHtml( perm ) + '</span> '
                } )

                html += '</span></div>'
            }

            html += '</div>'

            // UI Categories
            html += '<h3 style="margin-top:16px">Categories</h3>'
            html += renderCategoryGrid( {
                'supportsMcpApps': cats.uiSupportsMcpApps,
                'hasUiResources': cats.uiHasUiResources,
                'hasToolLinkage': cats.uiHasToolLinkage,
                'hasValidHtml': cats.uiHasValidHtml,
                'hasValidCsp': cats.uiHasValidCsp,
                'supportsTheming': cats.uiSupportsTheming
            } )

            // UI Resources list
            if( ui.uiResources && ui.uiResources.length > 0 ) {
                html += '<h3 style="margin-top:16px">UI Resources</h3>'
                html += '<div class="tools-grid">'

                ui.uiResources.forEach( function( res ) {
                    html += '<div class="tool-item">'
                    html += '<div class="tool-name">' + escapeHtml( res.uri || res.name || '-' ) + '</div>'

                    var parts = []

                    if( res.mimeType ) { parts.push( res.mimeType ) }
                    if( res.hasCsp ) { parts.push( 'CSP' ) }
                    if( res.displayModes && res.displayModes.length > 0 ) { parts.push( res.displayModes.join( ', ' ) ) }

                    if( parts.length > 0 ) {
                        html += '<div class="tool-desc">' + escapeHtml( parts.join( ' · ' ) ) + '</div>'
                    }

                    html += '</div>'
                } )

                html += '</div>'
            }

            // Linked Tools list
            if( ui.uiLinkedTools && ui.uiLinkedTools.length > 0 ) {
                html += '<h3 style="margin-top:16px">UI-Linked Tools</h3>'
                html += '<div class="tools-grid">'

                ui.uiLinkedTools.forEach( function( tool ) {
                    html += '<div class="tool-item">'
                    html += '<div class="tool-name">' + escapeHtml( tool.name || '-' )

                    if( tool.visibility ) {
                        html += ' <span class="badge badge-purple">' + escapeHtml( Array.isArray( tool.visibility ) ? tool.visibility.join( ', ' ) : tool.visibility ) + '</span>'
                    }

                    html += '</div>'

                    if( tool.resourceUri ) {
                        html += '<div class="tool-desc">' + escapeHtml( tool.resourceUri ) + '</div>'
                    }

                    html += '</div>'
                } )

                html += '</div>'
            }

            html += '</div>'

            return html
        }

        // ── Validation Messages ──

        function renderMessages( messages ) {
            var html = '<div class="detail-section"><h3>Validation Messages</h3>'

            var errors = messages.filter( function( m ) { return m.severity === 'ERROR' } )
            var warnings = messages.filter( function( m ) { return m.severity === 'WARNING' } )
            var infos = messages.filter( function( m ) { return m.severity === 'INFO' } )

            if( errors.length > 0 ) {
                html += '<h4 style="margin-top:12px;color:#f04">Errors (' + errors.length + ')</h4>'
                html += '<ul class="messages-list">'

                errors.forEach( function( m ) { html += '<li>' + escapeHtml( m.message ) + '</li>' } )

                html += '</ul>'
            }

            if( warnings.length > 0 ) {
                html += '<h4 style="margin-top:12px;color:#fa0">Warnings (' + warnings.length + ')</h4>'
                html += '<ul class="messages-list">'

                warnings.forEach( function( m ) { html += '<li>' + escapeHtml( m.message ) + '</li>' } )

                html += '</ul>'
            }

            if( infos.length > 0 ) {
                html += '<h4 style="margin-top:12px;color:#888">Info (' + infos.length + ')</h4>'
                html += '<ul class="messages-list">'

                infos.forEach( function( m ) { html += '<li>' + escapeHtml( m.message ) + '</li>' } )

                html += '</ul>'
            }

            html += '</div>'

            return html
        }

        // ── Validate Action ──

        async function validate() {
            var urlInput = document.getElementById( 'urlInput' )
            var rawUrl = urlInput.value.trim()

            if( !rawUrl ) {
                showError( 'Please enter a URL to validate.' )

                return
            }

            if( rawUrl.indexOf( '://' ) === -1 ) {
                rawUrl = 'https://' + rawUrl
            }

            try {
                new URL( rawUrl )
            } catch( _e ) {
                showError( 'Invalid URL. Please enter a valid URL (e.g. https://example.com).' )

                return
            }

            setValidatorState( 'loading' )
            setLoadingText( 'Probing MCP, A2A, x402, OAuth, MCP Apps (server-side)...' )

            try {
                var response = await fetch( '/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { url: rawUrl } )
                } )

                var data = await response.json()

                if( data.error ) {
                    setValidatorState( 'idle' )
                    showError( data.error )

                    return
                }

                renderVerdicts( data )
                renderDetails( data )
                renderRawAssessment( data, rawUrl )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        document.getElementById( 'validateBtn' ).addEventListener( 'click', validate )

        document.getElementById( 'urlInput' ).addEventListener( 'keydown', function( e ) {
            if( e.key === 'Enter' ) { validate() }
        } )

        document.querySelectorAll( '.example-urls a' ).forEach( function( link ) {
            link.addEventListener( 'click', function( e ) {
                e.preventDefault()
                document.getElementById( 'urlInput' ).value = link.getAttribute( 'data-url' )
                validate()
            } )
        } )

        // ── Dependency Footer ──

        function loadDependencyInfo() {
            fetch( '/api/info' )
                .then( function( res ) { return res.json() } )
                .then( function( info ) {
                    var container = document.getElementById( 'depInfo' )

                    if( !info.dependencies || info.dependencies.length === 0 ) {
                        return
                    }

                    var links = info.dependencies
                        .map( function( dep ) {
                            if( !dep.shortHash || !dep.commitUrl ) {
                                return '<span class="dep-link">' + escapeHtml( dep.name ) + '</span>'
                            }

                            return '<a class="dep-link" href="' + escapeHtml( dep.commitUrl ) + '" target="_blank" rel="noopener">' +
                                escapeHtml( dep.name ) + ' <span class="dep-hash">' + escapeHtml( dep.shortHash ) + '</span></a>'
                        } )
                        .join( ' &middot; ' )

                    container.innerHTML = '<span class="dep-info-label">Validation modules</span>' + links
                } )
                .catch( function() {} )
        }

        loadDependencyInfo()

        // ── Raw Assessment Viewer ──

        function renderRawAssessment( data, url ) {
            var container = document.getElementById( 'rawAssessmentSection' )
            var jsonStr = JSON.stringify( data, null, 2 )

            var hostname = ''

            try {
                hostname = new URL( url ).hostname
            } catch( _e ) {
                hostname = 'unknown'
            }

            var timestamp = new Date().toISOString().replace( /[:.]/g, '-' ).slice( 0, 19 )
            var filename = 'assessment-' + hostname + '-' + timestamp + '.json'

            var html = '<div class="raw-toggle" id="rawToggle">' +
                '<span class="raw-arrow" id="rawArrow">&#9654;</span> Raw Assessment' +
                '</div>' +
                '<div class="raw-content" id="rawContent" style="display:none">' +
                '<div class="raw-actions">' +
                '<button class="raw-btn" id="rawCopyBtn">Copy</button>' +
                '<button class="raw-btn" id="rawDownloadBtn">Download</button>' +
                '</div>' +
                '<pre><code>' + escapeHtml( jsonStr ) + '</code></pre>' +
                '</div>'

            container.innerHTML = html

            document.getElementById( 'rawToggle' ).addEventListener( 'click', function() {
                var content = document.getElementById( 'rawContent' )
                var arrow = document.getElementById( 'rawArrow' )

                if( content.style.display === 'none' ) {
                    content.style.display = 'block'
                    arrow.innerHTML = '&#9660;'
                } else {
                    content.style.display = 'none'
                    arrow.innerHTML = '&#9654;'
                }
            } )

            document.getElementById( 'rawCopyBtn' ).addEventListener( 'click', function() {
                var btn = this

                navigator.clipboard.writeText( jsonStr ).then( function() {
                    btn.textContent = 'Copied!'
                    setTimeout( function() { btn.textContent = 'Copy' }, 2000 )
                } )
            } )

            document.getElementById( 'rawDownloadBtn' ).addEventListener( 'click', function() {
                var blob = new Blob( [ jsonStr ], { type: 'application/json' } )
                var a = document.createElement( 'a' )

                a.href = URL.createObjectURL( blob )
                a.download = filename
                document.body.appendChild( a )
                a.click()
                document.body.removeChild( a )
                URL.revokeObjectURL( a.href )
            } )
        }

    </script>
</body>
</html>
