<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Agent Validator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>MCP Agent Validator</h1>
            <p class="subtitle">Validate MCP, A2A, x402, OAuth, and MCP Apps endpoints</p>
        </header>

        <div>
            <div class="validator-input">
                <input type="text" id="urlInput" placeholder="https://your-endpoint.example.com" spellcheck="false">
                <button class="validator-btn" id="validateBtn">Validate</button>
            </div>

            <div class="example-urls">
                <span>Try:</span>
                <a data-url="https://x402.flowmcp.org/mcp/streamable">x402.flowmcp.org/mcp/streamable</a>
                <a data-url="https://blackjack.nanobot.ai/mcp">blackjack.nanobot.ai/mcp</a>
            </div>

            <div class="error-message" id="errorBox"></div>

            <div class="loading-section" id="loadingSection">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">Probing endpoint...</div>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="verdict-grid" id="verdictGrid"></div>
                <div id="detailSections"></div>
            </div>

            <div id="rawAssessmentSection" class="raw-assessment-section" style="display:none"></div>
        </div>

        <footer>
            <a href="https://github.com/FlowMCP/mcp-agent-validator">mcp-agent-validator</a> &middot;
            Server-side validation via Node.js probes
            <div id="depInfo" class="dep-info"></div>
        </footer>
    </div>

    <script>
        // ── Helpers ──

        function escapeHtml( str ) {
            var div = document.createElement( 'div' )
            div.textContent = str

            return div.innerHTML
        }

        function show( el ) { el.style.display = 'block' }
        function hide( el ) { el.style.display = 'none' }

        // ── Endpoint Validator ──

        function setValidatorState( state ) {
            var loading = document.getElementById( 'loadingSection' )
            var results = document.getElementById( 'resultsSection' )
            var rawSection = document.getElementById( 'rawAssessmentSection' )
            var errorBox = document.getElementById( 'errorBox' )
            var btn = document.getElementById( 'validateBtn' )

            hide( loading )
            hide( results )
            hide( rawSection )
            hide( errorBox )
            btn.disabled = false

            if( state === 'loading' ) {
                show( loading )
                btn.disabled = true
            } else if( state === 'results' ) {
                show( results )
                show( rawSection )
            }
        }

        function showError( msg ) {
            var errorBox = document.getElementById( 'errorBox' )
            errorBox.textContent = msg
            show( errorBox )
        }

        function setLoadingText( text ) {
            document.getElementById( 'loadingText' ).textContent = text
        }

        function isMcpDetected( mcp ) {
            if( !mcp.categories ) { return false }

            return mcp.categories.supportsMcp || mcp.categories.hasTools || mcp.summary.serverName !== null
        }

        function buildX402Detail( mcp ) {
            if( mcp.summary.x402ToolCount > 0 ) {
                return mcp.summary.x402ToolCount + ' payment tool' + ( mcp.summary.x402ToolCount !== 1 ? 's' : '' )
            }

            var parts = []
            if( mcp.summary.networks && mcp.summary.networks.length > 0 ) {
                parts.push( mcp.summary.networks.length + ' network' + ( mcp.summary.networks.length !== 1 ? 's' : '' ) )
            }
            if( mcp.summary.schemes && mcp.summary.schemes.length > 0 ) {
                parts.push( mcp.summary.schemes.join( ', ' ) )
            }

            return parts.length > 0 ? parts.join( ' · ' ) : 'Supported'
        }

        function renderVerdicts( mcp, a2a, ui, oauth ) {
            var grid = document.getElementById( 'verdictGrid' )

            var mcpDetected = isMcpDetected( mcp )
            var x402Detected = mcp.categories && mcp.categories.supportsX402
            var oauthDetected = oauth && oauth.status

            var cards = [
                {
                    label: 'MCP',
                    pass: mcpDetected,
                    detail: mcpDetected
                        ? ( mcp.summary.serverName || 'MCP Server' ) + ' (' + mcp.summary.toolCount + ' tools)'
                        : 'Not detected'
                },
                {
                    label: 'A2A',
                    pass: a2a.categories && a2a.categories.hasAgentCard,
                    detail: a2a.categories && a2a.categories.hasAgentCard
                        ? ( a2a.summary.agentName || 'A2A Agent' )
                        : 'Not detected'
                },
                {
                    label: 'x402',
                    pass: x402Detected,
                    detail: x402Detected
                        ? buildX402Detail( mcp )
                        : 'Not detected'
                },
                {
                    label: 'OAuth',
                    pass: oauthDetected,
                    detail: oauthDetected
                        ? ( oauth.summary.issuer || 'OAuth detected' )
                        : 'Not required'
                },
                {
                    label: 'MCP Apps',
                    pass: ui.categories && ui.categories.supportsMcpApps,
                    detail: ui.categories && ui.categories.supportsMcpApps
                        ? ui.summary.uiResourceCount + ' UI resource' + ( ui.summary.uiResourceCount !== 1 ? 's' : '' )
                        : 'Not detected'
                }
            ]

            grid.innerHTML = cards.map( function( card ) {
                var cls = card.pass ? 'pass' : 'fail'
                var icon = card.pass
                    ? '<span class="check-yes" style="font-size:28px">&#10003;</span>'
                    : '<span class="check-no" style="font-size:28px">&#10005;</span>'

                return '<div class="verdict-card ' + cls + '">' +
                    '<div class="verdict-icon">' + icon + '</div>' +
                    '<div class="verdict-label">' + escapeHtml( card.label ) + '</div>' +
                    '<div class="verdict-detail">' + escapeHtml( card.detail ) + '</div>' +
                    '</div>'
            } ).join( '' )
        }

        function renderDetails( mcp, a2a, ui, oauth ) {
            var container = document.getElementById( 'detailSections' )
            var html = ''

            // MCP Detail
            if( isMcpDetected( mcp ) ) {
                html += '<div class="detail-section"><h3>MCP Server</h3>'
                html += '<div class="probe-summary">'
                html += '<div class="field"><span class="label">Server Name:</span> <span>' + escapeHtml( mcp.summary.serverName || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Server Version:</span> <span>' + escapeHtml( mcp.summary.serverVersion || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Tools Count:</span> <span>' + mcp.summary.toolCount + '</span></div>'

                if( mcp.summary.latencyPingMs !== null ) {
                    var pingPct = Math.min( mcp.summary.latencyPingMs / 5000 * 100, 100 )
                    html += '<div class="latency-bar">'
                    html += '<span class="latency-label">Ping Latency:</span>'
                    html += '<div class="latency-track"><div class="latency-fill" style="width:' + pingPct + '%"></div></div>'
                    html += '<span class="latency-value">' + mcp.summary.latencyPingMs + ' ms</span>'
                    html += '</div>'
                }

                if( mcp.summary.latencyListToolsMs !== null ) {
                    var toolsPct = Math.min( mcp.summary.latencyListToolsMs / 5000 * 100, 100 )
                    html += '<div class="latency-bar">'
                    html += '<span class="latency-label">Tools Latency:</span>'
                    html += '<div class="latency-track"><div class="latency-fill" style="width:' + toolsPct + '%"></div></div>'
                    html += '<span class="latency-value">' + mcp.summary.latencyListToolsMs + ' ms</span>'
                    html += '</div>'
                }

                html += '</div>'

                // Categories
                html += '<h3 style="margin-top:16px">Categories</h3>'
                html += '<div class="categories-grid">'
                var catKeys = Object.keys( mcp.categories )
                catKeys.forEach( function( key ) {
                    var val = mcp.categories[ key ]
                    var icon = val
                        ? '<span class="check-yes">&#10003;</span>'
                        : '<span class="check-no">&#10005;</span>'
                    html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
                } )
                html += '</div>'

                // Tools list
                if( mcp.tools && mcp.tools.length > 0 ) {
                    html += '<h3 style="margin-top:16px">Tools</h3>'
                    html += '<div class="tools-grid">'

                    var x402ToolNames = {}
                    if( mcp.x402Tools ) {
                        mcp.x402Tools.forEach( function( t ) {
                            x402ToolNames[ t.name || t ] = true
                        } )
                    }

                    var uiToolNames = {}
                    if( ui && ui.uiLinkedTools ) {
                        ui.uiLinkedTools.forEach( function( t ) {
                            uiToolNames[ t.name || t ] = true
                        } )
                    }

                    mcp.tools.forEach( function( tool ) {
                        var toolName = tool.name || '-'
                        var isX402 = x402ToolNames[ toolName ] || false

                        if( !isX402 ) {
                            var str = JSON.stringify( tool ).toLowerCase()
                            isX402 = str.indexOf( 'x402' ) !== -1 ||
                                str.indexOf( 'paymentrequir' ) !== -1 ||
                                str.indexOf( 'payment_requir' ) !== -1
                        }

                        var isUI = uiToolNames[ toolName ] || false

                        var cls = isX402 ? 'tool-item x402-tool' : 'tool-item'
                        html += '<div class="' + cls + '">'
                        html += '<div class="tool-name">' + escapeHtml( toolName )
                        if( isX402 ) { html += ' <span class="badge badge-green">x402</span>' }
                        if( isUI ) { html += ' <span class="badge badge-purple">UI</span>' }
                        html += '</div>'
                        html += '<div class="tool-desc">' + escapeHtml( ( tool.description || '' ).substring( 0, 120 ) ) + '</div>'
                        html += '</div>'
                    } )

                    html += '</div>'
                }

                html += '</div>'
            }

            // A2A Detail
            if( a2a.categories && a2a.categories.hasAgentCard ) {
                html += '<div class="detail-section"><h3>A2A Agent</h3>'
                html += '<div class="probe-summary">'
                html += '<div class="field"><span class="label">Agent Name:</span> <span>' + escapeHtml( a2a.summary.agentName || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Description:</span> <span>' + escapeHtml( a2a.summary.agentDescription || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Version:</span> <span>' + escapeHtml( a2a.summary.agentVersion || '-' ) + '</span></div>'

                if( a2a.summary.provider && ( a2a.summary.provider.organization || a2a.summary.provider.url ) ) {
                    var providerText = a2a.summary.provider.organization || '-'
                    html += '<div class="field"><span class="label">Provider:</span> <span>'
                    if( a2a.summary.provider.url ) {
                        html += '<a href="' + escapeHtml( a2a.summary.provider.url ) + '" target="_blank" rel="noopener">' + escapeHtml( providerText ) + '</a>'
                    } else {
                        html += escapeHtml( providerText )
                    }
                    html += '</span></div>'
                }

                html += '<div class="field"><span class="label">Skills:</span> <span>' + a2a.summary.skillCount + '</span></div>'

                if( a2a.summary.skills && a2a.summary.skills.length > 0 ) {
                    html += '<div class="field"><span class="label">Skill List:</span> <span>'
                    a2a.summary.skills.forEach( function( skill ) {
                        html += '<span class="badge badge-blue">' + escapeHtml( skill.name || skill.id || '-' ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( a2a.summary.protocolVersion ) {
                    html += '<div class="field"><span class="label">Protocol Version:</span> <span>' + escapeHtml( a2a.summary.protocolVersion ) + '</span></div>'
                }

                if( a2a.summary.protocolBindings && a2a.summary.protocolBindings.length > 0 ) {
                    html += '<div class="field"><span class="label">Protocol Bindings:</span> <span>'
                    a2a.summary.protocolBindings.forEach( function( binding ) {
                        html += '<span class="badge badge-blue">' + escapeHtml( typeof binding === 'string' ? binding : JSON.stringify( binding ) ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( a2a.summary.latencyMs !== null ) {
                    var a2aPct = Math.min( a2a.summary.latencyMs / 5000 * 100, 100 )
                    html += '<div class="latency-bar">'
                    html += '<span class="latency-label">Latency:</span>'
                    html += '<div class="latency-track"><div class="latency-fill" style="width:' + a2aPct + '%"></div></div>'
                    html += '<span class="latency-value">' + a2a.summary.latencyMs + ' ms</span>'
                    html += '</div>'
                }

                html += '</div>'

                // A2A Categories
                html += '<h3 style="margin-top:16px">Categories</h3>'
                html += '<div class="categories-grid">'
                Object.keys( a2a.categories ).forEach( function( key ) {
                    var val = a2a.categories[ key ]
                    var icon = val
                        ? '<span class="check-yes">&#10003;</span>'
                        : '<span class="check-no">&#10005;</span>'
                    html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
                } )
                html += '</div>'

                html += '</div>'
            }

            // x402 Detail
            if( mcp.categories && mcp.categories.supportsX402 ) {
                html += '<div class="detail-section"><h3>x402 Payment Support</h3>'
                html += '<div class="probe-summary">'

                if( mcp.summary.networks && mcp.summary.networks.length > 0 ) {
                    html += '<div class="field"><span class="label">Networks:</span> <span>'
                    mcp.summary.networks.forEach( function( n ) {
                        html += '<span class="badge badge-green">' + escapeHtml( n ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( mcp.summary.schemes && mcp.summary.schemes.length > 0 ) {
                    html += '<div class="field"><span class="label">Schemes:</span> <span>'
                    mcp.summary.schemes.forEach( function( s ) {
                        html += '<span class="badge badge-blue">' + escapeHtml( s ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                // Payment Requirements
                if( mcp.x402PaymentRequirements && mcp.x402PaymentRequirements.length > 0 ) {
                    html += '</div>'
                    html += '<h3 style="margin-top:16px">Payment Requirements</h3>'
                    html += '<div class="tools-grid">'
                    mcp.x402PaymentRequirements.forEach( function( pr ) {
                        html += '<div class="tool-item x402-tool">'
                        if( pr.network ) { html += '<div class="tool-name">' + escapeHtml( pr.network ) + '</div>' }
                        var details = []
                        if( pr.scheme ) { details.push( 'Scheme: ' + pr.scheme ) }
                        if( pr.maxAmountRequired ) { details.push( 'Max: ' + pr.maxAmountRequired ) }
                        if( pr.resource ) { details.push( 'Resource: ' + pr.resource ) }
                        if( pr.payTo ) { details.push( 'Pay to: ' + pr.payTo.substring( 0, 10 ) + '...' + pr.payTo.slice( -6 ) ) }
                        if( details.length > 0 ) {
                            html += '<div class="tool-desc">' + escapeHtml( details.join( ' · ' ) ) + '</div>'
                        }
                        html += '</div>'
                    } )
                    html += '</div>'
                } else {
                    html += '</div>'
                }

                html += '</div>'
            }

            // OAuth Detail
            if( oauth && oauth.status ) {
                html += '<div class="detail-section"><h3>OAuth / Authorization</h3>'
                html += '<div class="probe-summary">'
                html += '<div class="field"><span class="label">Issuer:</span> <span>' + escapeHtml( oauth.summary.issuer || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Authorization Endpoint:</span> <span>' + escapeHtml( oauth.summary.authorizationEndpoint || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">Token Endpoint:</span> <span>' + escapeHtml( oauth.summary.tokenEndpoint || '-' ) + '</span></div>'

                if( oauth.summary.registrationEndpoint ) {
                    html += '<div class="field"><span class="label">Registration Endpoint:</span> <span>' + escapeHtml( oauth.summary.registrationEndpoint ) + '</span></div>'
                }

                if( oauth.summary.grantTypesSupported && oauth.summary.grantTypesSupported.length > 0 ) {
                    html += '<div class="field"><span class="label">Grant Types:</span> <span>'
                    oauth.summary.grantTypesSupported.forEach( function( gt ) {
                        html += '<span class="badge badge-blue">' + escapeHtml( gt ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( oauth.summary.pkceMethodsSupported && oauth.summary.pkceMethodsSupported.length > 0 ) {
                    html += '<div class="field"><span class="label">PKCE Methods:</span> <span>'
                    oauth.summary.pkceMethodsSupported.forEach( function( m ) {
                        html += '<span class="badge badge-green">' + escapeHtml( m ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( oauth.summary.scopesSupported && oauth.summary.scopesSupported.length > 0 ) {
                    html += '<div class="field"><span class="label">Scopes:</span> <span>'
                    oauth.summary.scopesSupported.forEach( function( s ) {
                        html += '<span class="badge badge-purple">' + escapeHtml( s ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                html += '</div>'

                // Categories
                html += '<h3 style="margin-top:16px">Categories</h3>'
                html += '<div class="categories-grid">'
                Object.keys( oauth.categories ).forEach( function( key ) {
                    var val = oauth.categories[ key ]
                    var icon = val
                        ? '<span class="check-yes">&#10003;</span>'
                        : '<span class="check-no">&#10005;</span>'
                    html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
                } )
                html += '</div>'

                html += '</div>'
            }

            // MCP Apps Detail
            if( ui.categories && ui.categories.supportsMcpApps ) {
                html += '<div class="detail-section"><h3>MCP Apps</h3>'
                html += '<div class="probe-summary">'
                html += '<div class="field"><span class="label">Extension Version:</span> <span>' + escapeHtml( ui.summary.extensionVersion || '-' ) + '</span></div>'
                html += '<div class="field"><span class="label">UI Resources:</span> <span>' + ui.summary.uiResourceCount + '</span></div>'
                html += '<div class="field"><span class="label">Linked Tools:</span> <span>' + ui.summary.uiLinkedToolCount + '</span></div>'
                html += '<div class="field"><span class="label">App-Only Tools:</span> <span>' + ui.summary.appOnlyToolCount + '</span></div>'

                if( ui.summary.displayModes && ui.summary.displayModes.length > 0 ) {
                    html += '<div class="field"><span class="label">Display Modes:</span> <span>'
                    ui.summary.displayModes.forEach( function( mode ) {
                        html += '<span class="badge badge-purple">' + escapeHtml( mode ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                if( ui.permissionsSummary && ui.permissionsSummary.length > 0 ) {
                    html += '<div class="field"><span class="label">Permissions:</span> <span>'
                    ui.permissionsSummary.forEach( function( perm ) {
                        html += '<span class="badge badge-blue">' + escapeHtml( perm ) + '</span> '
                    } )
                    html += '</span></div>'
                }

                html += '</div>'

                // Categories
                html += '<h3 style="margin-top:16px">Categories</h3>'
                html += '<div class="categories-grid">'
                Object.keys( ui.categories ).forEach( function( key ) {
                    var val = ui.categories[ key ]
                    var icon = val
                        ? '<span class="check-yes">&#10003;</span>'
                        : '<span class="check-no">&#10005;</span>'
                    html += '<div class="category-item">' + icon + ' <span>' + escapeHtml( key ) + '</span></div>'
                } )
                html += '</div>'

                // UI Resources list
                if( ui.uiResources && ui.uiResources.length > 0 ) {
                    html += '<h3 style="margin-top:16px">UI Resources</h3>'
                    html += '<div class="tools-grid">'
                    ui.uiResources.forEach( function( res ) {
                        html += '<div class="tool-item">'
                        html += '<div class="tool-name">' + escapeHtml( res.uri || res.name || '-' ) + '</div>'
                        var parts = []
                        if( res.mimeType ) { parts.push( res.mimeType ) }
                        if( res.hasCsp ) { parts.push( 'CSP' ) }
                        if( res.displayModes && res.displayModes.length > 0 ) { parts.push( res.displayModes.join( ', ' ) ) }
                        if( parts.length > 0 ) {
                            html += '<div class="tool-desc">' + escapeHtml( parts.join( ' · ' ) ) + '</div>'
                        }
                        html += '</div>'
                    } )
                    html += '</div>'
                }

                // Linked Tools list
                if( ui.uiLinkedTools && ui.uiLinkedTools.length > 0 ) {
                    html += '<h3 style="margin-top:16px">UI-Linked Tools</h3>'
                    html += '<div class="tools-grid">'
                    ui.uiLinkedTools.forEach( function( tool ) {
                        html += '<div class="tool-item">'
                        html += '<div class="tool-name">' + escapeHtml( tool.name || '-' )
                        if( tool.visibility ) {
                            html += ' <span class="badge badge-purple">' + escapeHtml( Array.isArray( tool.visibility ) ? tool.visibility.join( ', ' ) : tool.visibility ) + '</span>'
                        }
                        html += '</div>'
                        if( tool.resourceUri ) {
                            html += '<div class="tool-desc">' + escapeHtml( tool.resourceUri ) + '</div>'
                        }
                        html += '</div>'
                    } )
                    html += '</div>'
                }

                html += '</div>'
            }

            // Validation Messages
            if( mcp.messages && mcp.messages.length > 0 ) {
                html += '<div class="detail-section"><h3>Validation Messages</h3>'
                html += '<ul class="messages-list">'
                mcp.messages.forEach( function( msg ) {
                    html += '<li>' + escapeHtml( msg ) + '</li>'
                } )
                html += '</ul></div>'
            }

            // MCP Apps Messages
            if( ui.messages && ui.messages.length > 0 ) {
                html += '<div class="detail-section"><h3>MCP Apps Messages</h3>'
                html += '<ul class="messages-list">'
                ui.messages.forEach( function( msg ) {
                    html += '<li>' + escapeHtml( msg ) + '</li>'
                } )
                html += '</ul></div>'
            }

            // OAuth Messages
            if( oauth && oauth.messages && oauth.messages.length > 0 ) {
                html += '<div class="detail-section"><h3>OAuth Messages</h3>'
                html += '<ul class="messages-list">'
                oauth.messages.forEach( function( msg ) {
                    html += '<li>' + escapeHtml( msg ) + '</li>'
                } )
                html += '</ul></div>'
            }

            container.innerHTML = html
        }

        async function validate() {
            var urlInput = document.getElementById( 'urlInput' )
            var rawUrl = urlInput.value.trim()

            if( !rawUrl ) {
                showError( 'Please enter a URL to validate.' )

                return
            }

            if( rawUrl.indexOf( '://' ) === -1 ) {
                rawUrl = 'https://' + rawUrl
            }

            try {
                new URL( rawUrl )
            } catch( _e ) {
                showError( 'Invalid URL. Please enter a valid URL (e.g. https://example.com).' )

                return
            }

            setValidatorState( 'loading' )
            setLoadingText( 'Probing MCP and A2A (server-side)...' )

            try {
                var response = await fetch( '/api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { url: rawUrl } )
                } )

                var data = await response.json()

                if( data.error ) {
                    setValidatorState( 'idle' )
                    showError( data.error )

                    return
                }

                renderVerdicts( data.mcp, data.a2a, data.ui, data.oauth || null )
                renderDetails( data.mcp, data.a2a, data.ui, data.oauth || null )
                renderRawAssessment( data, rawUrl )
                setValidatorState( 'results' )
            } catch( err ) {
                setValidatorState( 'idle' )
                showError( 'Server error: ' + ( err.message || 'Unknown' ) )
            }
        }

        document.getElementById( 'validateBtn' ).addEventListener( 'click', validate )

        document.getElementById( 'urlInput' ).addEventListener( 'keydown', function( e ) {
            if( e.key === 'Enter' ) { validate() }
        } )

        document.querySelectorAll( '.example-urls a' ).forEach( function( link ) {
            link.addEventListener( 'click', function( e ) {
                e.preventDefault()
                document.getElementById( 'urlInput' ).value = link.getAttribute( 'data-url' )
                validate()
            } )
        } )

        // ── Dependency Footer ──

        function loadDependencyInfo() {
            fetch( '/api/info' )
                .then( function( res ) { return res.json() } )
                .then( function( info ) {
                    var container = document.getElementById( 'depInfo' )

                    if( !info.dependencies || info.dependencies.length === 0 ) {
                        return
                    }

                    var html = info.dependencies
                        .map( function( dep ) {
                            if( !dep.shortHash || !dep.commitUrl ) {
                                return '<span class="dep-link">' + escapeHtml( dep.name ) + '</span>'
                            }

                            return '<a class="dep-link" href="' + escapeHtml( dep.commitUrl ) + '" target="_blank" rel="noopener">' +
                                escapeHtml( dep.name ) + ' <span class="dep-hash">' + escapeHtml( dep.shortHash ) + '</span></a>'
                        } )
                        .join( ' &middot; ' )

                    container.innerHTML = html
                } )
                .catch( function() {} )
        }

        loadDependencyInfo()

        // ── Raw Assessment Viewer ──

        function renderRawAssessment( data, url ) {
            var container = document.getElementById( 'rawAssessmentSection' )
            var jsonStr = JSON.stringify( data, null, 2 )

            var hostname = ''
            try {
                hostname = new URL( url ).hostname
            } catch( _e ) {
                hostname = 'unknown'
            }

            var timestamp = new Date().toISOString().replace( /[:.]/g, '-' ).slice( 0, 19 )
            var filename = 'assessment-' + hostname + '-' + timestamp + '.json'

            var html = '<div class="raw-toggle" id="rawToggle">' +
                '<span class="raw-arrow" id="rawArrow">&#9654;</span> Raw Assessment' +
                '</div>' +
                '<div class="raw-content" id="rawContent" style="display:none">' +
                '<div class="raw-actions">' +
                '<button class="raw-btn" id="rawCopyBtn">Copy</button>' +
                '<button class="raw-btn" id="rawDownloadBtn">Download</button>' +
                '</div>' +
                '<pre><code>' + escapeHtml( jsonStr ) + '</code></pre>' +
                '</div>'

            container.innerHTML = html

            document.getElementById( 'rawToggle' ).addEventListener( 'click', function() {
                var content = document.getElementById( 'rawContent' )
                var arrow = document.getElementById( 'rawArrow' )

                if( content.style.display === 'none' ) {
                    content.style.display = 'block'
                    arrow.innerHTML = '&#9660;'
                } else {
                    content.style.display = 'none'
                    arrow.innerHTML = '&#9654;'
                }
            } )

            document.getElementById( 'rawCopyBtn' ).addEventListener( 'click', function() {
                var btn = this
                navigator.clipboard.writeText( jsonStr ).then( function() {
                    btn.textContent = 'Copied!'
                    setTimeout( function() { btn.textContent = 'Copy' }, 2000 )
                } )
            } )

            document.getElementById( 'rawDownloadBtn' ).addEventListener( 'click', function() {
                var blob = new Blob( [ jsonStr ], { type: 'application/json' } )
                var a = document.createElement( 'a' )
                a.href = URL.createObjectURL( blob )
                a.download = filename
                document.body.appendChild( a )
                a.click()
                document.body.removeChild( a )
                URL.revokeObjectURL( a.href )
            } )
        }

    </script>
</body>
</html>
